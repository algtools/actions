name: "Update Template Manifest"
description: "Updates .template-manifest.json with current version and fresh checksums"
inputs:
  working_directory:
    description: "Directory containing the template"
    required: true
  github_token:
    description: "GitHub token for committing changes"
    required: true
runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install dependencies for manifest update
      shell: bash
      working-directory: ${{ github.action_path }}
      run: |
        if [ ! -d "node_modules" ]; then
          npm install
        fi

    - name: Update manifest with fresh checksums
      shell: bash
      run: |
        set -euo pipefail

        echo "ğŸ”„ Regenerating template manifest..."

        # Resolve absolute path to template directory
        TEMPLATE_DIR="$(cd "${{ inputs.working_directory }}" && pwd)"
        echo "ğŸ“ Template directory: ${TEMPLATE_DIR}"

        # Run the manifest update script using npx from the action directory
        cd "${{ github.action_path }}"
        npx tsx ./updateManifest.ts "${TEMPLATE_DIR}"

    - name: Commit updated manifest
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        set -euo pipefail

        MANIFEST_FILE=".template-manifest.json"

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if there are changes
        if git diff --quiet "${MANIFEST_FILE}"; then
          echo "âœ“ No changes to manifest"
        else
          echo "ğŸ“ Committing updated manifest..."
          git add "${MANIFEST_FILE}"
          git commit -m "chore: update template manifest checksums [skip ci]" --no-verify

          # Pull latest changes with rebase to avoid conflicts
          echo "ğŸ”„ Pulling latest changes..."
          git pull --rebase origin "$(git branch --show-current)"

          echo "ğŸ“¤ Pushing changes..."
          git push
          echo "âœ… Manifest committed and pushed"
        fi
