name: "Update Provisioned App"
description: "Updates an app using incremental diffs with smart merge rules for special files"
author: "Algtools"

branding:
  icon: "refresh-cw"
  color: "blue"

inputs:
  source_repo:
    description: "Source template repository (e.g., algtools/core-template)"
    required: true
  target_repo:
    description: "Target repository to update (e.g., owner/my-app)"
    required: true
  version:
    description: 'Target template version (e.g., v1.8.2 or "latest")'
    required: false
    default: "latest"
  base_branch:
    description: "Base branch to create PR against"
    required: false
    default: "main"
  branch_name:
    description: "Name for the update branch (default: algtools/{template_name}-{version})"
    required: false
    default: ""
  pr_title:
    description: "Title for the pull request (auto-generated if not provided)"
    required: false
    default: ""
  pr_body:
    description: "Body for the pull request (auto-generated if not provided)"
    required: false
    default: ""
  github_token:
    description: "GitHub token with repo permissions"
    required: true
  dry_run:
    description: "Perform a dry run without creating PR"
    required: false
    default: "false"

outputs:
  pr_url:
    description: "URL of the created pull request"
    value: ${{ steps.create-pr.outputs.pr_url }}
  pr_number:
    description: "Number of the created pull request"
    value: ${{ steps.create-pr.outputs.pr_number }}
  release_tag:
    description: "Template version used for the update"
    value: ${{ steps.resolve-version.outputs.version }}
  branch_name:
    description: "Name of the branch created"
    value: ${{ steps.setup.outputs.branch_name }}
  versions_applied:
    description: "Number of versions successfully applied"
    value: ${{ steps.apply-changes.outputs.versions_applied }}
  files_changed:
    description: "Total number of files changed"
    value: ${{ steps.apply-changes.outputs.files_changed }}

runs:
  using: "composite"
  steps:
    - name: Display Action Version
      shell: bash
      run: |
        ACTION_NAME="Update Provisioned App"
        cd "${GITHUB_ACTION_PATH}/../../.."
        VERSION="v$(jq -r '.version' package.json 2>/dev/null || echo 'dev')"
        echo "ðŸ”§ algtools/actions: ${ACTION_NAME} | Version: ${VERSION}"
        echo "## ðŸ”§ ${ACTION_NAME} | ${VERSION}" >> "$GITHUB_STEP_SUMMARY"

    - name: Setup dependencies
      shell: bash
      run: |
        echo "::group::Installing dependencies"
        # Install jq if not available
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            sudo apt-get update && sudo apt-get install -y jq
          elif [[ "$OSTYPE" == "darwin"* ]]; then
            brew install jq
          fi
        fi

        # Install Node.js dependencies for rule engine
        cd "${GITHUB_ACTION_PATH}/rules"
        if [ ! -d "node_modules" ]; then
          npm install --silent js-yaml minimatch 2>&1 | grep -v "^npm WARN" || true
        fi

        echo "âœ“ Dependencies installed"
        echo "::endgroup::"

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo }}
        token: ${{ inputs.github_token }}
        fetch-depth: 0
        path: target-repo

    - name: Detect current version
      id: detect-version
      shell: bash
      working-directory: target-repo
      run: |
        echo "::group::Detecting current template version"
        bash "${GITHUB_ACTION_PATH}/scripts/detect-version.sh"
        echo "::endgroup::"

    - name: Resolve target version
      id: resolve-version
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        SOURCE_REPO: ${{ inputs.source_repo }}
        VERSION_INPUT: ${{ inputs.version }}
      run: |
        echo "::group::Resolving target version"

        VERSION="${VERSION_INPUT:-latest}"

        if [ "$VERSION" = "latest" ]; then
          echo "Fetching latest release..."
          RELEASE_DATA=$(gh api "/repos/${SOURCE_REPO}/releases/latest" 2>&1) || {
            echo "::error::Failed to fetch latest release"
            exit 1
          }
          VERSION=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ“ Target version: $VERSION"
        echo "::endgroup::"

    - name: Check if update needed
      id: check-update
      shell: bash
      run: |
        current="${{ steps.detect-version.outputs.current_version }}"
        target="${{ steps.resolve-version.outputs.version }}"

        if [ "$current" = "$target" ]; then
          echo "::notice::Already on target version $target. No update needed."
          echo "update_needed=false" >> $GITHUB_OUTPUT
        else
          echo "::notice::Update needed: $current â†’ $target"
          echo "update_needed=true" >> $GITHUB_OUTPUT
        fi

    - name: Query intermediate versions
      id: query-versions
      if: steps.check-update.outputs.update_needed == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        SOURCE_REPO: ${{ inputs.source_repo }}
        CURRENT_VERSION: ${{ steps.detect-version.outputs.current_version }}
        TARGET_VERSION: ${{ steps.resolve-version.outputs.version }}
      run: |
        echo "::group::Querying intermediate versions"
        bash "${GITHUB_ACTION_PATH}/scripts/query-versions.sh" > versions.json

        versions_count=$(jq 'length' versions.json)
        echo "versions_count=$versions_count" >> $GITHUB_OUTPUT
        echo "âœ“ Found $versions_count intermediate version(s)"
        echo "::endgroup::"

    - name: Collect version diffs
      id: collect-diffs
      if: steps.check-update.outputs.update_needed == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        SOURCE_REPO: ${{ inputs.source_repo }}
      run: |
        echo "::group::Collecting version diffs"
        mkdir -p diffs

        bash "${GITHUB_ACTION_PATH}/scripts/collect-diffs.sh" \
          versions.json \
          diffs > diffs-metadata.json

        echo "âœ“ Diffs collected"
        echo "::endgroup::"

    - name: Setup branch
      id: setup
      if: steps.check-update.outputs.update_needed == 'true'
      shell: bash
      working-directory: target-repo
      run: |
        echo "::group::Setting up branch"

        template_name="${{ steps.detect-version.outputs.template_name }}"
        target_version="${{ steps.resolve-version.outputs.version }}"

        # Generate branch name
        if [ -n "${{ inputs.branch_name }}" ]; then
          branch_name="${{ inputs.branch_name }}"
        else
          version_slug=$(echo "$target_version" | sed 's/v//g' | sed 's/\./-/g')
          branch_name="algtools/${template_name}-${version_slug}"
        fi

        echo "branch_name=$branch_name" >> $GITHUB_OUTPUT

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create or checkout branch
        git checkout -b "$branch_name" 2>/dev/null || git checkout "$branch_name"

        echo "âœ“ Working on branch: $branch_name"
        echo "::endgroup::"

    - name: Apply changes with rules
      id: apply-changes
      if: steps.check-update.outputs.update_needed == 'true'
      shell: bash
      working-directory: target-repo
      env:
        RULES_ENGINE_PATH: ${{ github.action_path }}/rules
        DRY_RUN: ${{ inputs.dry_run }}
      run: |
        echo "::group::Applying changes with rule processing"

        bash "${GITHUB_ACTION_PATH}/scripts/apply-changes.sh" \
          ../diffs \
          ../diffs-metadata.json > application-report.json

        # Extract stats
        versions_applied=$(jq -r '.applied' application-report.json)
        files_changed=$(jq -r '.files_changed' application-report.json)

        echo "versions_applied=$versions_applied" >> $GITHUB_OUTPUT
        echo "files_changed=$files_changed" >> $GITHUB_OUTPUT

        echo "âœ“ Applied $versions_applied version(s), changed $files_changed file(s)"
        echo "::endgroup::"

    - name: Generate PR description
      id: generate-pr-desc
      if: steps.check-update.outputs.update_needed == 'true'
      shell: bash
      run: |
        echo "::group::Generating PR description"

        bash "${GITHUB_ACTION_PATH}/scripts/generate-pr-description.sh" \
          "${{ steps.detect-version.outputs.current_version }}" \
          "${{ steps.resolve-version.outputs.version }}" \
          diffs-metadata.json \
          application-report.json \
          "${{ steps.detect-version.outputs.template_name }}" > pr-description.md

        echo "âœ“ PR description generated"
        echo "::endgroup::"

    - name: Push changes
      if: steps.check-update.outputs.update_needed == 'true' && inputs.dry_run == 'false'
      shell: bash
      working-directory: target-repo
      run: |
        echo "::group::Pushing changes"

        git add -A

        if git diff --staged --quiet; then
          echo "::notice::No changes to commit"
        else
          git commit -m "chore: update template from ${{ steps.detect-version.outputs.current_version }} to ${{ steps.resolve-version.outputs.version }}"
          git push -u origin "${{ steps.setup.outputs.branch_name }}" --force
          echo "âœ“ Changes pushed"
        fi

        echo "::endgroup::"

    - name: Create Pull Request
      id: create-pr
      if: steps.check-update.outputs.update_needed == 'true' && inputs.dry_run == 'false'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        TARGET_REPO: ${{ inputs.target_repo }}
        BASE_BRANCH: ${{ inputs.base_branch }}
        BRANCH_NAME: ${{ steps.setup.outputs.branch_name }}
        RELEASE_TAG: ${{ steps.resolve-version.outputs.version }}
        PR_TITLE_INPUT: ${{ inputs.pr_title }}
        PR_BODY_INPUT: ${{ inputs.pr_body }}
      run: |
        echo "::group::Creating pull request"

        cd target-repo

        # Determine PR title
        if [ -n "${PR_TITLE_INPUT}" ]; then
          PR_TITLE="${PR_TITLE_INPUT}"
        else
          PR_TITLE="chore: update template to ${RELEASE_TAG}"
        fi

        # Determine PR body
        if [ -f "../pr-description.md" ]; then
          PR_BODY=$(cat ../pr-description.md)
        elif [ -n "${PR_BODY_INPUT}" ]; then
          PR_BODY="${PR_BODY_INPUT}"
        else
          PR_BODY="Updates template to version ${RELEASE_TAG}"
        fi

        # Check if PR exists
        existing_pr=$(gh pr list \
          --repo "${TARGET_REPO}" \
          --head "${BRANCH_NAME}" \
          --base "${BASE_BRANCH}" \
          --json number,url \
          --jq '.[0] // empty' 2>/dev/null || echo "")

        if [ -n "${existing_pr}" ]; then
          pr_number=$(echo "${existing_pr}" | jq -r '.number')
          pr_url=$(echo "${existing_pr}" | jq -r '.url')
          echo "::notice::Updating existing PR #${pr_number}"
          gh pr edit "${pr_number}" --title "${PR_TITLE}" --body "${PR_BODY}"
        else
          echo "::notice::Creating new PR"
          pr_url=$(gh pr create \
            --repo "${TARGET_REPO}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            --base "${BASE_BRANCH}" \
            --head "${BRANCH_NAME}" \
            --label "template-update" \
            --label "dependencies")

          pr_number=$(gh pr view "${pr_url}" --repo "${TARGET_REPO}" --json number --jq '.number')
        fi

        echo "pr_number=${pr_number}" >> $GITHUB_OUTPUT
        echo "pr_url=${pr_url}" >> $GITHUB_OUTPUT
        echo "âœ“ Pull request: ${pr_url}"
        echo "::endgroup::"

    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "## Template Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check-update.outputs.update_needed }}" != "true" ]; then
          echo "âœ… Already on latest version - no update needed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### Update Details" >> $GITHUB_STEP_SUMMARY
          echo "- **From Version:** ${{ steps.detect-version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **To Version:** ${{ steps.resolve-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Template:** ${{ steps.detect-version.outputs.template_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Versions Applied:** ${{ steps.apply-changes.outputs.versions_applied }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed:** ${{ steps.apply-changes.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Dry Run Mode** - No PR was created" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create-pr.outputs.pr_url }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [${{ steps.create-pr.outputs.pr_url }}](${{ steps.create-pr.outputs.pr_url }})" >> $GITHUB_STEP_SUMMARY
          fi
        fi
