name: "PR Build - Reusable Workflow"

on:
  workflow_call:
    inputs:
      build_cmd:
        description: 'Build command to execute (e.g., "npm run build", "tsc", "yarn build")'
        required: true
        type: string
      artifact_name:
        description: "Name of the artifact to upload"
        required: true
        type: string
      artifact_paths:
        description: "Comma-separated list of file paths or directories to upload as artifacts"
        required: true
        type: string
      node_version:
        description: "Node.js version to install. If not provided, reads from .nvmrc file."
        required: false
        type: string
        default: ""
      working_directory:
        description: "Working directory for build commands"
        required: false
        type: string
        default: "."
      output_dir:
        description: 'Directory where build output/artifacts will be produced (e.g., "dist", "build")'
        required: false
        type: string
        default: "dist"
      retention_days:
        description: "Number of days to retain the artifact (1-90 days, default is repository/org setting)"
        required: false
        type: number
        default: 30
      deploy_to_dev:
        description: "Enable deployment to Cloudflare Workers dev environment with SSL certificate"
        required: false
        type: boolean
        default: false
      worker_name:
        description: "Name of the Cloudflare Worker for dev deployment (required if deploy_to_dev is true)"
        required: false
        type: string
        default: ""
      wrangler_config:
        description: "Path to wrangler.toml configuration file relative to artifact root (required if deploy_to_dev is true)"
        required: false
        type: string
        default: "wrangler.toml"
      zone:
        description: "Cloudflare zone ID for the domain (required if deploy_to_dev is true)"
        required: false
        type: string
        default: ""
      custom_domain:
        description: "Custom domain for deployment (required if deploy_to_dev is true). SSL certificate must be pre-generated."
        required: false
        type: string
        default: ""
      wrangler_version:
        description: "Version of Wrangler to use for deployment (default: latest)"
        required: false
        type: string
        default: "latest"
    secrets:
      cloudflare_api_token:
        description: "Cloudflare API token with Workers deployment permissions (required if deploy_to_dev is true)"
        required: false
      cloudflare_account_id:
        description: "Cloudflare account ID (required if deploy_to_dev is true)"
        required: false
    outputs:
      artifact_id:
        description: "GitHub artifact ID of the uploaded artifact"
        value: ${{ jobs.build.outputs.artifact_id }}
      artifact_url:
        description: "URL to download the artifact"
        value: ${{ jobs.build.outputs.artifact_url }}
      total_files:
        description: "Total number of files uploaded"
        value: ${{ jobs.build.outputs.total_files }}
      total_size:
        description: "Total size of uploaded files in bytes"
        value: ${{ jobs.build.outputs.total_size }}
      build_status:
        description: "Status of the build (success or failure)"
        value: ${{ jobs.build.outputs.build_status }}
      worker_url:
        description: "URL of the deployed Cloudflare Worker (only if deploy_to_dev is true)"
        value: ${{ jobs.deploy.outputs.worker_url }}
      deployment_status:
        description: "Status of the deployment (only if deploy_to_dev is true)"
        value: ${{ jobs.deploy.outputs.deployment_status }}

permissions:
  contents: read
  packages: read

jobs:
  build:
    name: Build and Upload Artifacts
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact_id }}
      artifact_url: ${{ steps.upload.outputs.artifact_url }}
      total_files: ${{ steps.upload.outputs.total_files }}
      total_size: ${{ steps.upload.outputs.total_size }}
      build_status: ${{ steps.build.outputs.build_status }}

    steps:
      - name: Display Workflow Version
        uses: algtools/actions/.github/actions/workflow-version-banner@main
        with:
          workflow_name: "PR Build - Reusable Workflow"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js securely
        id: setup
        uses: algtools/actions/.github/actions/setup-node@main
        with:
          node-version: ${{ inputs.node_version }}
          working-directory: ${{ inputs.working_directory }}
          github-token: ${{ github.token }}

      - name: Build without secrets
        id: build
        uses: algtools/actions/.github/actions/build-no-secrets@main
        with:
          build_cmd: ${{ inputs.build_cmd }}
          working_dir: ${{ inputs.working_directory }}
          output_dir: ${{ inputs.output_dir }}

      - name: Upload artifacts
        id: upload
        uses: algtools/actions/.github/actions/upload-artifacts@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          artifact_paths: ${{ inputs.artifact_paths }}
          retention_days: ${{ inputs.retention_days }}
          include_hidden_files: "true"

      - name: Summary
        run: |
          {
            echo "## PR Build Summary"
            echo ""
            echo "### Build Information"
            echo "- **Status**: ${{ steps.build.outputs.build_status }}"
            echo "- **Node Version**: ${{ steps.setup.outputs.node-version }}"
            echo "- **Package Manager**: ${{ steps.setup.outputs.package-manager }}"
            echo "- **Cache Hit**: ${{ steps.setup.outputs.cache-hit }}"
            echo ""
            echo "### Artifact Details"
            echo "- **Name**: ${{ inputs.artifact_name }}"
            echo "- **ID**: ${{ steps.upload.outputs.artifact_id }}"
            echo "- **Total Files**: ${{ steps.upload.outputs.total_files }}"
            echo "- **Total Size**: ${{ steps.upload.outputs.total_size }} bytes"
            echo "- **Retention**: ${{ inputs.retention_days }} days"
            echo ""
            echo "âœ“ Build and upload completed successfully"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    name: Deploy to Dev with SSL
    needs: build
    if: inputs.deploy_to_dev == true
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.worker_url }}
      deployment_status: ${{ steps.deploy-worker.outputs.deployment_status }}

    steps:
      - name: Display Workflow Version
        uses: algtools/actions/.github/actions/workflow-version-banner@main
        with:
          workflow_name: "PR Build - Reusable Workflow (Deploy Job)"

      - name: Validate deployment inputs
        run: |
          echo "::group::Validating deployment configuration"

          # Validate required inputs when deploy_to_dev is enabled
          if [ -z "${{ inputs.worker_name }}" ]; then
            echo "::error::worker_name is required when deploy_to_dev is enabled"
            exit 1
          fi
          if [ -z "${{ inputs.zone }}" ]; then
            echo "::error::zone is required when deploy_to_dev is enabled"
            exit 1
          fi
          if [ -z "${{ inputs.custom_domain }}" ]; then
            echo "::error::custom_domain is required when deploy_to_dev is enabled"
            exit 1
          fi
          if [ -z "${{ secrets.cloudflare_api_token }}" ]; then
            echo "::error::cloudflare_api_token secret is required when deploy_to_dev is enabled"
            exit 1
          fi
          if [ -z "${{ secrets.cloudflare_account_id }}" ]; then
            echo "::error::cloudflare_account_id secret is required when deploy_to_dev is enabled"
            exit 1
          fi

          echo "âœ“ All required deployment inputs validated"
          echo ""
          echo "Deployment Configuration:"
          echo "  Worker: ${{ inputs.worker_name }}"
          echo "  Domain: ${{ inputs.custom_domain }}"
          echo "  Zone: $(echo "${{ inputs.zone }}" | head -c 8)***"
          echo "  Artifact: ${{ inputs.artifact_name }}"
          echo "::endgroup::"

      - name: Deploy to Cloudflare Workers
        id: deploy-worker
        uses: algtools/actions/.github/actions/deploy-cloudflare-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          worker_name: ${{ inputs.worker_name }}
          wrangler_config: ${{ inputs.wrangler_config }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          wrangler_version: ${{ inputs.wrangler_version }}
          deploy_environment: "dev"
          dry_run: "false"

      - name: Deployment summary
        run: |
          {
            echo "## ðŸš€ PR Dev Deployment"
            echo ""
            echo "### Worker Details"
            echo "- **Name**: \`${{ inputs.worker_name }}\`"
            echo "- **URL**: ${{ steps.deploy-worker.outputs.worker_url }}"
            echo "- **Status**: ${{ steps.deploy-worker.outputs.deployment_status }}"
            echo "- **Version**: \`${{ steps.deploy-worker.outputs.worker_version }}\`"
            echo "### Artifact"
            echo "- **Name**: \`${{ inputs.artifact_name }}\`"
            echo "- **ID**: \`${{ needs.build.outputs.artifact_id }}\`"
            echo ""
            echo "âœ“ PR preview deployed successfully to dev environment"
          } >> "$GITHUB_STEP_SUMMARY"
