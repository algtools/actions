name: "Template Release - Reusable"

on:
  workflow_call:
    inputs:
      template_name:
        description: "Name of the template (e.g., bff-template)"
        required: true
        type: string
      working_directory:
        description: "Directory containing the template"
        required: false
        type: string
        default: "."
      branch:
        description: "Branch being released (dev/qa/main)"
        required: true
        type: string
      retention_days:
        description: "Artifact retention days"
        required: false
        type: number
        default: 30
    secrets:
      gh_token:
        required: true
      admin_token:
        required: false
    outputs:
      version:
        description: "Version that was released"
        value: ${{ jobs.release.outputs.version }}
      tarball_url:
        description: "URL to download tarball"
        value: ${{ jobs.release.outputs.tarball_url }}

permissions:
  contents: write
  packages: read
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tarball_url: ${{ steps.upload.outputs.artifact-url }}
    steps:
      - name: Display Workflow Version
        run: |
          WORKFLOW_NAME="Template Release - Reusable Workflow"
          VERSION="${{ github.action_repository }}@${{ github.action_ref }}"

          # Try to get version from package.json if running from algtools/actions
          if [ "${{ github.action_repository }}" = "algtools/actions" ]; then
            VERSION="v$(curl -sL https://raw.githubusercontent.com/algtools/actions/${{ github.action_ref }}/package.json | jq -r '.version')"
          fi

          echo "üîÑ algtools/actions workflow: ${WORKFLOW_NAME} | Version: ${VERSION}"
          echo "## üîÑ ${WORKFLOW_NAME} | ${VERSION}" >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.gh_token }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Version
        id: bump
        uses: algtools/actions/.github/actions/bump-version@main
        with:
          github_token: ${{ secrets.gh_token }}
          working_directory: ${{ inputs.working_directory }}

      - name: Get Current Version
        id: get-version
        working-directory: ${{ inputs.working_directory }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Current version: ${VERSION}"

      - name: Update template manifest
        uses: algtools/actions/.github/actions/update-template-manifest@main
        with:
          working_directory: ${{ inputs.working_directory }}
          github_token: ${{ secrets.gh_token }}

      - name: Determine template type
        id: template-type
        working-directory: ${{ inputs.working_directory }}
        run: |
          TEMPLATE_NAME="${{ inputs.template_name }}"
          if [[ "${TEMPLATE_NAME}" == *"web"* ]]; then
            echo "template_type=web" >> "$GITHUB_OUTPUT"
          elif [[ "${TEMPLATE_NAME}" == *"core"* ]]; then
            echo "template_type=core" >> "$GITHUB_OUTPUT"
          else
            echo "template_type=bff" >> "$GITHUB_OUTPUT"
          fi

      - name: Package Template
        id: package
        uses: algtools/actions/.github/actions/package-template@main
        with:
          working_directory: ${{ inputs.working_directory }}
          template_name: ${{ inputs.template_name }}
          template_type: ${{ steps.template-type.outputs.template_type }}
          version: ${{ steps.get-version.outputs.version }}

      - name: Upload Tarball Artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.tarball_name }}
          path: ${{ inputs.working_directory }}/${{ steps.package.outputs.tarball_path }}
          retention-days: ${{ inputs.retention_days }}

      - name: Upload Tarball to GitHub Release
        working-directory: ${{ inputs.working_directory }}
        env:
          GH_TOKEN: ${{ secrets.gh_token }}
        run: |
          VERSION="v${{ steps.get-version.outputs.version }}"
          TARBALL_PATH="${{ steps.package.outputs.tarball_path }}"

          echo "Uploading ${TARBALL_PATH} to release ${VERSION}..."

          # Upload tarball to the release created by semantic-release
          gh release upload "${VERSION}" "${TARBALL_PATH}" --clobber

          echo "‚úÖ Tarball uploaded to GitHub Release"

  sync-docs:
    needs: release
    runs-on: ubuntu-latest
    if: github.ref_name == 'main' || github.ref_name == 'qa'
    continue-on-error: true
    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4
        with:
          path: template-repo
          token: ${{ secrets.gh_token }}

      - name: Checkout template-docs repository
        id: checkout-docs
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: algtools/template-docs
          path: template-docs
          token: ${{ secrets.gh_token }}

      - name: Check if template-docs checkout succeeded
        if: steps.checkout-docs.outcome != 'success'
        run: |
          echo "‚ö†Ô∏è Warning: Could not checkout template-docs repository (algtools/template-docs)"
          echo "This may be because:"
          echo "  - The repository doesn't exist"
          echo "  - The token doesn't have access to it"
          echo "  - The repository is private and needs different permissions"
          echo ""
          echo "Skipping documentation sync. Release will continue."
          exit 0

      - name: Setup Node.js
        if: steps.checkout-docs.outcome == 'success'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        if: steps.checkout-docs.outcome == 'success'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        if: steps.checkout-docs.outcome == 'success'
        working-directory: template-docs
        run: pnpm install --frozen-lockfile

      - name: Sync documentation
        if: steps.checkout-docs.outcome == 'success'
        working-directory: template-docs
        run: |
          pnpm sync-docs \
            "${{ inputs.template_name }}" \
            "${{ needs.release.outputs.version }}" \
            "../template-repo/${{ inputs.working_directory }}/docs"

      - name: Commit changes
        if: steps.checkout-docs.outcome == 'success'
        working-directory: template-docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pages/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: sync ${{ inputs.template_name }} v${{ needs.release.outputs.version }}"
            git push
          fi
