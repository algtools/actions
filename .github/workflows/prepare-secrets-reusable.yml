name: "Prepare Secrets - Reusable Workflow"

on:
  workflow_call:
    # Accept individual secrets as inputs
    secrets:
      # Auth/API secrets
      auth_jwt_secret:
        description: "JWT secret for authentication"
        required: false
      api_key:
        description: "API key for external services"
        required: false

      # Database secrets
      database_url:
        description: "Database connection URL"
        required: false

      # AWS/S3 secrets
      s3_access_key_id:
        description: "AWS S3 access key ID"
        required: false
      s3_secret_access_key:
        description: "AWS S3 secret access key"
        required: false
      s3_bucket_name:
        description: "AWS S3 bucket name"
        required: false

      # External service secrets
      openai_api_key:
        description: "OpenAI API key"
        required: false
      sendgrid_api_key:
        description: "SendGrid API key"
        required: false
      stripe_secret_key:
        description: "Stripe secret key"
        required: false

      # Cloudflare (for special cases where worker needs its own account ID)
      cloudflare_account_id:
        description: "Cloudflare account ID (if needed as a worker secret)"
        required: false

      # Custom secrets (JSON format for flexibility)
      custom_secrets_json:
        description: 'Additional secrets as JSON string. Example: {"KEY1": "value1", "KEY2": "value2"}'
        required: false

    outputs:
      secrets_json:
        description: "JSON object containing all provided secrets"
        value: ${{ jobs.prepare.outputs.secrets_json }}

jobs:
  prepare:
    name: Build Secrets JSON
    runs-on: ubuntu-latest
    outputs:
      secrets_json: ${{ steps.build.outputs.secrets_json }}

    steps:
      - name: Build secrets JSON
        id: build
        shell: bash
        run: |
          # Start with empty JSON object
          SECRETS_JSON="{}"

          # Function to add secret to JSON if it exists
          add_secret() {
            local key="$1"
            local value="$2"

            if [ -n "$value" ]; then
              # Use jq to safely add to JSON
              SECRETS_JSON=$(echo "$SECRETS_JSON" | jq --arg key "$key" --arg value "$value" '. + {($key): $value}')
            fi
          }

          # Add each secret if provided
          add_secret "AUTH_JWT_SECRET" "${{ secrets.auth_jwt_secret }}"
          add_secret "API_KEY" "${{ secrets.api_key }}"
          add_secret "DATABASE_URL" "${{ secrets.database_url }}"
          add_secret "S3_ACCESS_KEY_ID" "${{ secrets.s3_access_key_id }}"
          add_secret "S3_SECRET_ACCESS_KEY" "${{ secrets.s3_secret_access_key }}"
          add_secret "S3_BUCKET_NAME" "${{ secrets.s3_bucket_name }}"
          add_secret "OPENAI_API_KEY" "${{ secrets.openai_api_key }}"
          add_secret "SENDGRID_API_KEY" "${{ secrets.sendgrid_api_key }}"
          add_secret "STRIPE_SECRET_KEY" "${{ secrets.stripe_secret_key }}"
          add_secret "CLOUDFLARE_ACCOUNT_ID" "${{ secrets.cloudflare_account_id }}"

          # Merge custom secrets if provided
          if [ -n "${{ secrets.custom_secrets_json }}" ] && [ "${{ secrets.custom_secrets_json }}" != "{}" ]; then
            CUSTOM_JSON='${{ secrets.custom_secrets_json }}'
            SECRETS_JSON=$(echo "$SECRETS_JSON $CUSTOM_JSON" | jq -s '.[0] * .[1]')
          fi

          # Output the final JSON
          echo "Prepared secrets JSON (keys only):"
          echo "$SECRETS_JSON" | jq 'keys'

          {
            echo "secrets_json<<EOF"
            echo "$SECRETS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          {
            echo "## ðŸ” Secrets Prepared"
            echo ""
            echo "Secrets have been prepared for deployment."
            echo "Secret values are masked in logs for security."
            echo ""
            echo "### Secret Keys Configured:"
            echo '```json'
            echo '${{ steps.build.outputs.secrets_json }}' | jq 'keys'
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
