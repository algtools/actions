name: "Provision Template - Reusable"

on:
  workflow_call:
    inputs:
      target_org:
        description: "Target organization name (e.g., 'janovix', 'carteracredit'). If not provided, uses source repository organization."
        required: false
        type: string
        default: ""
      app_name:
        description: "Name of the repository to create (e.g. acme-bff)"
        required: true
        type: string
      database_name:
        description: "Database name (e.g. acme-api) - will be suffixed with -dev, -qa, -prod (core-template only)"
        required: false
        type: string
        default: ""
      sentry_project:
        description: "Sentry project name (defaults to repository name if not provided)"
        required: false
        type: string
        default: ""
      sentry_dsn:
        description: "Sentry DSN for error monitoring (optional)"
        required: false
        type: string
        default: ""
      chromatic_project_token:
        description: "Chromatic project token for visual regression testing (optional, web-template only)"
        required: false
        type: string
        default: ""
      version:
        description: "Template release tag (use 'latest' for newest release)"
        required: false
        type: string
        default: "latest"
    secrets:
      admin_token:
        description: "Personal Access Token with repo and admin:org scopes"
        required: true
      sentry_token:
        description: "Sentry authentication token (optional)"
        required: false
      cloudflare_api_token:
        description: "Cloudflare API token for D1 database creation (optional, core-template only)"
        required: false
      cloudflare_account_id:
        description: "Cloudflare Account ID for D1 database creation (optional, core-template only)"
        required: false
    outputs:
      repository_url:
        description: "URL of the created repository"
        value: ${{ jobs.provision.outputs.repository_url }}
      release_tag:
        description: "Template version used"
        value: ${{ jobs.provision.outputs.release_tag }}

permissions:
  contents: read
  id-token: write

jobs:
  provision:
    name: Provision Template
    runs-on: ubuntu-latest
    outputs:
      repository_url: ${{ steps.provision.outputs.repository_url }}
      release_tag: ${{ steps.provision.outputs.release_tag }}
    steps:
      - name: Display Workflow Version
        run: |
          WORKFLOW_NAME="Provision Template - Reusable Workflow"
          VERSION="${{ github.action_repository }}@${{ github.action_ref }}"

          # Try to get version from package.json if running from algtools/actions
          if [ "${{ github.action_repository }}" = "algtools/actions" ]; then
            VERSION="v$(curl -sL https://raw.githubusercontent.com/algtools/actions/${{ github.action_ref }}/package.json | jq -r '.version')"
          fi

          echo "ðŸ”„ Workflow: ${WORKFLOW_NAME} | Version: ${VERSION}"
          echo "## ðŸ”„ ${WORKFLOW_NAME} | ${VERSION}" >> "$GITHUB_STEP_SUMMARY"

      - name: Provision template repository
        id: provision
        uses: algtools/actions/.github/actions/provision-template@main
        with:
          source_repo: ${{ github.repository }}
          target_org: ${{ inputs.target_org }}
          app_name: ${{ inputs.app_name }}
          database_name: ${{ inputs.database_name }}
          sentry_project: ${{ inputs.sentry_project }}
          sentry_dsn: ${{ inputs.sentry_dsn }}
          chromatic_project_token: ${{ inputs.chromatic_project_token }}
          version: ${{ inputs.version }}
          admin_token: ${{ secrets.admin_token }}
          github_token: ${{ github.token }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
