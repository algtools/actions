name: Test Deploy Cloudflare from Artifact

on:
  push:
    branches:
      - main
      - 'cursor/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  test-dry-run-deployment:
    name: Test Dry Run Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          working-directory: '.github/tests/deploy-cloudflare'
          cache-dependency-path: '.github/tests/deploy-cloudflare/package-lock.json'

      - name: Build test worker
        uses: ./.github/actions/build-no-secrets
        with:
          build_cmd: 'npm run build'
          working_dir: '.github/tests/deploy-cloudflare'
          output_dir: 'dist'

      - name: Upload worker artifact
        id: upload
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'test-worker-dry-run'
          artifact_paths: '.github/tests/deploy-cloudflare/dist'

      - name: Verify upload
        run: |
          echo "Artifact uploaded:"
          echo "  ID: ${{ steps.upload.outputs.artifact_id }}"
          echo "  Files: ${{ steps.upload.outputs.total_files }}"
          echo "  Size: ${{ steps.upload.outputs.total_size }} bytes"

      - name: Deploy worker (dry run)
        id: deploy
        uses: ./.github/actions/deploy-cloudflare-from-artifact
        with:
          artifact_name: 'test-worker-dry-run'
          worker_name: 'test-worker-dry-run'
          wrangler_config: 'wrangler.toml'
          cloudflare_api_token: 'mock-token-for-dry-run'
          cloudflare_account_id: 'mock-account-id'
          dry_run: 'true'
        continue-on-error: true

      - name: Verify dry run outputs
        run: |
          echo "Dry run deployment outputs:"
          echo "  Status: ${{ steps.deploy.outputs.deployment_status }}"
          echo "  Worker URL: ${{ steps.deploy.outputs.worker_url }}"
          echo "  Version: ${{ steps.deploy.outputs.worker_version }}"
          echo ""
          echo "✓ Dry run test completed"

  test-artifact-download-validation:
    name: Test Artifact Download and Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          working-directory: '.github/tests/deploy-cloudflare'
          cache-dependency-path: '.github/tests/deploy-cloudflare/package-lock.json'

      - name: Build test worker
        uses: ./.github/actions/build-no-secrets
        with:
          build_cmd: 'npm run build'
          working_dir: '.github/tests/deploy-cloudflare'
          output_dir: 'dist'

      - name: Upload worker artifact
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'test-worker-validation'
          artifact_paths: '.github/tests/deploy-cloudflare/dist'

      - name: Test artifact download
        uses: actions/download-artifact@v4
        with:
          name: 'test-worker-validation'
          path: './downloaded-worker'

      - name: Verify artifact contents
        run: |
          echo "Verifying downloaded artifact contents..."
          
          if [ ! -f "./downloaded-worker/worker.js" ]; then
            echo "❌ Error: worker.js not found in artifact"
            exit 1
          fi
          echo "✓ worker.js found"
          
          if [ ! -f "./downloaded-worker/wrangler.toml" ]; then
            echo "❌ Error: wrangler.toml not found in artifact"
            exit 1
          fi
          echo "✓ wrangler.toml found"
          
          echo ""
          echo "Artifact contents:"
          ls -lah ./downloaded-worker/
          
          echo ""
          echo "✓ Artifact validation successful"

  test-input-validation:
    name: Test Input Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create dummy artifact
        run: |
          mkdir -p test-validation
          echo "test" > test-validation/test.txt
          echo "name = \"test\"" > test-validation/wrangler.toml

      - name: Upload dummy artifact
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'test-validation'
          artifact_paths: 'test-validation'

      - name: Test missing worker_name (should fail)
        id: test-missing-worker-name
        uses: ./.github/actions/deploy-cloudflare-from-artifact
        with:
          artifact_name: 'test-validation'
          worker_name: ''
          wrangler_config: 'wrangler.toml'
          cloudflare_api_token: 'mock-token'
          cloudflare_account_id: 'mock-account'
        continue-on-error: true

      - name: Verify validation caught missing worker_name
        run: |
          if [ "${{ steps.test-missing-worker-name.outcome }}" = "failure" ]; then
            echo "✓ Input validation correctly caught missing worker_name"
          else
            echo "❌ Input validation should have failed for missing worker_name"
            exit 1
          fi

  test-wrangler-installation:
    name: Test Wrangler Installation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        wrangler-version: ['latest', '3.78.0']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test Wrangler installation
        run: |
          echo "Testing Wrangler installation with version: ${{ matrix.wrangler-version }}"
          
          if [ "${{ matrix.wrangler-version }}" = "latest" ]; then
            npm install -g wrangler
          else
            npm install -g wrangler@${{ matrix.wrangler-version }}
          fi
          
          INSTALLED_VERSION=$(wrangler --version)
          echo "✓ Wrangler installed: $INSTALLED_VERSION"
          
          # Verify wrangler is accessible
          which wrangler || exit 1
          echo "✓ Wrangler is in PATH"

  test-complete-workflow:
    name: Test Complete Build and Deploy Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          working-directory: '.github/tests/deploy-cloudflare'
          cache-dependency-path: '.github/tests/deploy-cloudflare/package-lock.json'

      - name: Build worker
        id: build
        uses: ./.github/actions/build-no-secrets
        with:
          build_cmd: 'npm run build'
          working_dir: '.github/tests/deploy-cloudflare'
          output_dir: 'dist'

      - name: Upload worker artifacts
        id: upload
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'complete-workflow-worker-${{ github.run_id }}'
          artifact_paths: '.github/tests/deploy-cloudflare/dist'
          retention_days: '7'

      - name: Deploy worker (dry run)
        id: deploy
        uses: ./.github/actions/deploy-cloudflare-from-artifact
        with:
          artifact_name: 'complete-workflow-worker-${{ github.run_id }}'
          worker_name: 'complete-test-worker'
          wrangler_config: 'wrangler.toml'
          cloudflare_api_token: 'mock-token-for-testing'
          cloudflare_account_id: 'mock-account-id'
          dry_run: 'true'
        continue-on-error: true

      - name: Display complete workflow summary
        run: |
          echo "========================================="
          echo "Complete Workflow Summary"
          echo "========================================="
          echo ""
          echo "Build Phase:"
          echo "  Status: ${{ steps.build.outputs.build_status }}"
          echo "  Output: ${{ steps.build.outputs.output_path }}"
          echo "  Size: ${{ steps.build.outputs.artifact_size }} bytes"
          echo ""
          echo "Upload Phase:"
          echo "  Artifact ID: ${{ steps.upload.outputs.artifact_id }}"
          echo "  Files: ${{ steps.upload.outputs.total_files }}"
          echo "  Size: ${{ steps.upload.outputs.total_size }} bytes"
          echo ""
          echo "Deploy Phase:"
          echo "  Status: ${{ steps.deploy.outputs.deployment_status }}"
          echo "  Worker URL: ${{ steps.deploy.outputs.worker_url }}"
          echo "  Version: ${{ steps.deploy.outputs.worker_version }}"
          echo ""
          echo "✓ Complete workflow test executed successfully"

  test-multi-environment:
    name: Test Multi-Environment Deployment
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ['staging', 'production']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          working-directory: '.github/tests/deploy-cloudflare'
          cache-dependency-path: '.github/tests/deploy-cloudflare/package-lock.json'

      - name: Build worker
        uses: ./.github/actions/build-no-secrets
        with:
          build_cmd: 'npm run build'
          working_dir: '.github/tests/deploy-cloudflare'
          output_dir: 'dist'

      - name: Upload worker artifact
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'multi-env-worker-${{ matrix.environment }}'
          artifact_paths: '.github/tests/deploy-cloudflare/dist'

      - name: Deploy to ${{ matrix.environment }} (dry run)
        id: deploy
        uses: ./.github/actions/deploy-cloudflare-from-artifact
        with:
          artifact_name: 'multi-env-worker-${{ matrix.environment }}'
          worker_name: 'test-worker'
          wrangler_config: 'wrangler.toml'
          deploy_environment: ${{ matrix.environment }}
          cloudflare_api_token: 'mock-token'
          cloudflare_account_id: 'mock-account'
          dry_run: 'true'
        continue-on-error: true

      - name: Verify environment deployment
        run: |
          echo "Deployment to ${{ matrix.environment }}:"
          echo "  Status: ${{ steps.deploy.outputs.deployment_status }}"
          echo "  Worker URL: ${{ steps.deploy.outputs.worker_url }}"
          echo ""
          echo "✓ ${{ matrix.environment }} deployment test completed"

  test-security-filtering:
    name: Test Security and Secret Filtering
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          working-directory: '.github/tests/deploy-cloudflare'
          cache-dependency-path: '.github/tests/deploy-cloudflare/package-lock.json'

      - name: Build worker
        uses: ./.github/actions/build-no-secrets
        with:
          build_cmd: 'npm run build'
          working_dir: '.github/tests/deploy-cloudflare'
          output_dir: 'dist'

      - name: Upload worker artifact
        uses: ./.github/actions/upload-artifacts
        with:
          artifact_name: 'security-test-worker'
          artifact_paths: '.github/tests/deploy-cloudflare/dist'

      - name: Deploy with sensitive data (dry run)
        id: deploy
        uses: ./.github/actions/deploy-cloudflare-from-artifact
        with:
          artifact_name: 'security-test-worker'
          worker_name: 'security-test'
          wrangler_config: 'wrangler.toml'
          cloudflare_api_token: 'super-secret-token-12345'
          cloudflare_account_id: 'account-abc123def456'
          dry_run: 'true'
        continue-on-error: true

      - name: Verify secrets are masked
        run: |
          echo "Testing secret masking..."
          echo ""
          echo "The following should NOT appear in logs:"
          echo "  - super-secret-token-12345 (should be masked)"
          echo "  - account-abc123def456 (should be partially masked)"
          echo ""
          echo "✓ If you can read this, secret masking is working"
          echo "✓ Sensitive values should be [REDACTED] or masked with ***"
