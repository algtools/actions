name: "Preview Deploy - Reusable Workflow"
# Reusable workflow for deploying PR previews to Cloudflare Workers
# Automatically posts/updates a comment on the PR with deployment info

on:
  workflow_call:
    inputs:
      # Build configuration
      build_cmd:
        description: 'Build command to execute (e.g., "npm run build", "tsc", "yarn build")'
        required: true
        type: string
      artifact_name:
        description: "Name of the artifact to upload"
        required: true
        type: string
      artifact_paths:
        description: "Comma-separated list of file paths or directories to upload as artifacts"
        required: true
        type: string
      node_version:
        description: "Node.js version to install. If not provided, reads from .nvmrc file."
        required: false
        type: string
        default: ""
      working_directory:
        description: "Working directory for build commands"
        required: false
        type: string
        default: "."
      output_dir:
        description: 'Directory where build output/artifacts will be produced (e.g., "dist", "build")'
        required: false
        type: string
        default: "dist"

      # Deployment configuration
      slug:
        description: 'Project slug (e.g., "template", "bff-template")'
        required: true
        type: string
      app_name:
        description: 'Application name (e.g., "api", "web")'
        required: true
        type: string
      wrangler_config:
        description: "Path to wrangler.toml configuration file relative to artifact root"
        required: false
        type: string
        default: "wrangler.toml"
      zone:
        description: "Cloudflare zone ID for the domain"
        required: true
        type: string
      custom_domain:
        description: "Custom domain for preview deployment. SSL certificate must be pre-generated using generate-ssl-certificate workflow."
        required: true
        type: string
      wrangler_version:
        description: "Version of Wrangler to use for deployment (default: latest)"
        required: false
        type: string
        default: "latest"

      # Preview URL configuration
      app_domain:
        description: "Application domain prefix (used to construct preview URL: {app_domain}-pr-{num}.{dev_zone})"
        required: true
        type: string
      dev_zone:
        description: 'Development zone suffix for preview URLs (e.g., "dev.example.com")'
        required: true
        type: string

      # Chromatic configuration (optional)
      enable_chromatic:
        description: "Enable Chromatic visual testing upload"
        required: false
        type: boolean
        default: false
      storybook_build_dir:
        description: "Directory containing Storybook build (required if enable_chromatic is true)"
        required: false
        type: string
        default: "storybook-static"

      # API Documentation configuration (optional)
      enable_api_docs:
        description: "Enable API documentation generation"
        required: false
        type: boolean
        default: false
      api_docs_type:
        description: "Type of API documentation to generate (scalar, redoc, swagger-ui)"
        required: false
        type: string
        default: "scalar"
      api_docs_output_dir:
        description: "Directory where API documentation will be generated"
        required: false
        type: string
        default: "api-docs"

      # PR Comment configuration
      preview_links:
        description: "Comma-separated list of links to show in PR comment (preview,api-docs,openapi-spec,health,storybook)"
        required: false
        type: string
        default: "preview,api-docs,openapi-spec,health"

      # Ephemeral Database configuration (optional)
      enable_ephemeral_db:
        description: "Enable ephemeral database management for migrations"
        required: false
        type: boolean
        default: false
      migrations_dir:
        description: "Directory containing migration files (required if enable_ephemeral_db is true)"
        required: false
        type: string
        default: "migrations"
      database_binding:
        description: "Database binding name in wrangler config"
        required: false
        type: string
        default: "DB"
      base_branch:
        description: "Base branch to compare migrations against"
        required: false
        type: string
        default: "origin/dev"
      enable_seeding:
        description: "Whether to seed the database after migrations"
        required: false
        type: boolean
        default: true
      seed_script:
        description: "Script to generate seed SQL"
        required: false
        type: string
        default: "pnpm run db:seed:sql"
      seed_file:
        description: "Path to generated seed SQL file"
        required: false
        type: string
        default: "seeds.sql"

      # Miscellaneous
      retention_days:
        description: "Number of days to retain the artifact (1-90 days, default is repository/org setting)"
        required: false
        type: number
        default: 30

    secrets:
      cloudflare_api_token:
        description: "Cloudflare API token with Workers deployment permissions"
        required: true
      cloudflare_account_id:
        description: "Cloudflare account ID"
        required: true
      chromatic_project_token:
        description: "Chromatic project token for visual testing (optional)"
        required: false

    outputs:
      # Build outputs
      artifact_id:
        description: "GitHub artifact ID of the uploaded artifact"
        value: ${{ jobs.build.outputs.artifact_id }}
      artifact_url:
        description: "URL to download the artifact"
        value: ${{ jobs.build.outputs.artifact_url }}
      build_status:
        description: "Status of the build (success or failure)"
        value: ${{ jobs.build.outputs.build_status }}

      # Deploy outputs
      worker_url:
        description: "URL of the deployed Cloudflare Worker"
        value: ${{ jobs.deploy.outputs.worker_url }}
      deployment_status:
        description: "Status of the deployment"
        value: ${{ jobs.deploy.outputs.deployment_status }}

      # Preview outputs
      preview_url:
        description: "Public preview URL for the PR"
        value: ${{ jobs.deploy.outputs.preview_url }}

      # Chromatic outputs
      chromatic_url:
        description: "URL to Chromatic visual testing results (if enabled)"
        value: ${{ jobs.chromatic.outputs.chromatic_url }}

      # API Documentation outputs
      api_docs_url:
        description: "URL to API documentation (if enabled)"
        value: ${{ jobs.api-docs.outputs.api_docs_url }}
      api_docs_status:
        description: "Status of API documentation generation"
        value: ${{ jobs.api-docs.outputs.api_docs_status }}

      # Comment outputs
      comment_id:
        description: "ID of the PR comment"
        value: ${{ jobs.comment.outputs.comment_id }}
      comment_url:
        description: "URL of the PR comment"
        value: ${{ jobs.comment.outputs.comment_url }}

      # Ephemeral Database outputs
      database_created:
        description: "Whether an ephemeral database was created"
        value: ${{ jobs.manage-database.outputs.database_created }}
      database_name:
        description: "Name of the ephemeral database (empty if using dev database)"
        value: ${{ jobs.manage-database.outputs.database_name }}
      database_id:
        description: "ID of the ephemeral database (empty if using dev database)"
        value: ${{ jobs.manage-database.outputs.database_id }}
      has_new_migrations:
        description: "Whether new migrations were detected"
        value: ${{ jobs.manage-database.outputs.has_new_migrations }}

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact_id }}
      artifact_url: ${{ steps.upload.outputs.artifact_url }}
      total_files: ${{ steps.upload.outputs.total_files }}
      total_size: ${{ steps.upload.outputs.total_size }}
      build_status: ${{ steps.download.outcome == 'success' && 'success' || steps.build.outputs.build_status }}
      artifact_source: ${{ steps.download.outcome == 'success' && 'downloaded' || 'built' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Try to download existing artifact
        id: download
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.working_directory }}

      - name: Verify downloaded artifact
        if: steps.download.outcome == 'success'
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "::group::Verifying downloaded artifact"
          OUTPUT_DIR="${{ inputs.output_dir }}"

          if [ -d "$OUTPUT_DIR" ]; then
            echo "‚úì Artifact downloaded successfully from previous job"
            echo "‚úì Output directory exists: $OUTPUT_DIR"
            echo "‚úì Skipping build step (using pre-built artifact)"
            ls -lah "$OUTPUT_DIR" || true
          else
            echo "::warning::Artifact downloaded but output directory not found at: $OUTPUT_DIR"
            echo "::warning::Will proceed to build from source"
            exit 1
          fi
          echo "::endgroup::"

      - name: Setup Node.js securely
        if: steps.download.outcome != 'success'
        id: setup
        uses: algtools/actions/.github/actions/setup-node@main
        with:
          node-version: ${{ inputs.node_version }}
          working-directory: ${{ inputs.working_directory }}
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      - name: Build without secrets
        if: steps.download.outcome != 'success'
        id: build
        uses: algtools/actions/.github/actions/build-no-secrets@main
        with:
          build_cmd: ${{ inputs.build_cmd }}
          working_dir: ${{ inputs.working_directory }}
          output_dir: ${{ inputs.output_dir }}

      - name: Upload artifacts
        id: upload
        uses: algtools/actions/.github/actions/upload-artifacts@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          artifact_paths: ${{ inputs.artifact_paths }}
          retention_days: ${{ inputs.retention_days }}
          include_hidden_files: "true"

  manage-database:
    name: Manage Ephemeral Database
    needs: build
    if: inputs.enable_ephemeral_db == true
    runs-on: ubuntu-latest
    outputs:
      has_new_migrations: ${{ steps.manage-db.outputs.has_new_migrations }}
      new_migration_count: ${{ steps.manage-db.outputs.new_migration_count }}
      new_migrations: ${{ steps.manage-db.outputs.new_migrations }}
      database_created: ${{ steps.manage-db.outputs.database_created }}
      database_name: ${{ steps.manage-db.outputs.database_name }}
      database_id: ${{ steps.manage-db.outputs.database_id }}
      migrations_applied: ${{ steps.manage-db.outputs.migrations_applied }}
      seeding_status: ${{ steps.manage-db.outputs.seeding_status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git migration comparison

      - name: Setup Node.js
        uses: algtools/actions/.github/actions/setup-node@main
        with:
          node-version: ${{ inputs.node_version }}
          working-directory: ${{ inputs.working_directory }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.working_directory }}

      - name: Manage Ephemeral Database
        id: manage-db
        uses: algtools/actions/.github/actions/manage-ephemeral-database@main
        with:
          repository_name: ${{ github.event.repository.name }}
          pr_number: ${{ github.event.pull_request.number }}
          base_branch: ${{ inputs.base_branch }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          migrations_dir: ${{ inputs.migrations_dir }}
          working_directory: ${{ inputs.working_directory }}
          wrangler_config: ${{ inputs.wrangler_config }}
          database_binding: ${{ inputs.database_binding }}
          enable_seeding: ${{ inputs.enable_seeding }}
          seed_script: ${{ inputs.seed_script }}
          seed_file: ${{ inputs.seed_file }}
          wrangler_version: ${{ inputs.wrangler_version }}

      - name: Re-upload artifact with updated config
        if: steps.manage-db.outputs.database_created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: |
            ${{ inputs.working_directory }}
          retention-days: ${{ inputs.retention_days }}
          overwrite: true

  deploy:
    name: Deploy Preview
    needs: [build, manage-database]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (inputs.enable_ephemeral_db == false || needs.manage-database.result == 'success' || needs.manage-database.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: "preview-${{ github.event.pull_request.number }}"
      url: "https://${{ inputs.app_domain }}.${{ inputs.dev_zone }}"
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.worker_url }}
      deployment_status: ${{ steps.deploy-worker.outputs.deployment_status }}
      preview_url: ${{ steps.preview-url.outputs.url }}
      pr_number: ${{ steps.resolve-pr.outputs.number }}
      worker_name: ${{ steps.worker-name.outputs.name }}

    steps:
      - name: Resolve PR number
        id: resolve-pr
        run: |
          echo "::group::Resolving PR number"

          PR_NUMBER=""

          # Try to get PR number from different event contexts
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Direct pull_request trigger
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "PR number from pull_request event: ${PR_NUMBER}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # workflow_run trigger (e.g., from pull_request_target or fork PRs)
            # Extract from head_branch if it follows a PR pattern
            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "Head branch from workflow_run: ${HEAD_BRANCH}"

            # Try to extract PR number from associated pull requests
            if [ -n "${{ github.event.workflow_run.pull_requests[0].number }}" ]; then
              PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
              echo "PR number from workflow_run pull_requests: ${PR_NUMBER}"
            fi
          fi

          # Fallback: try to extract from ref if it's a PR ref
          if [ -z "$PR_NUMBER" ]; then
            REF="${{ github.ref }}"
            if [[ "$REF" =~ refs/pull/([0-9]+)/ ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "PR number extracted from ref: ${PR_NUMBER}"
            fi
          fi

          # Validate PR number
          if [ -z "$PR_NUMBER" ]; then
            echo "::error::Could not resolve PR number from event context"
            echo "Event name: ${{ github.event_name }}"
            echo "Ref: ${{ github.ref }}"
            exit 1
          fi

          echo "‚úì Resolved PR number: ${PR_NUMBER}"
          echo "number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Construct preview domain
        id: preview-domain
        run: |
          echo "::group::Constructing preview domain"
          PREVIEW_DOMAIN="${{ inputs.app_domain }}.${{ inputs.dev_zone }}"
          echo "domain=${PREVIEW_DOMAIN}" >> "$GITHUB_OUTPUT"
          echo "Preview domain: ${PREVIEW_DOMAIN}"
          echo "::endgroup::"

      - name: Construct worker name
        id: worker-name
        run: |
          echo "::group::Constructing worker name"

          PR_NUMBER="${{ steps.resolve-pr.outputs.number }}"
          SLUG="${{ inputs.slug }}"
          APP_NAME="${{ inputs.app_name }}"

          # Construct worker name: <slug>-<app_name>-preview-<pr-number>
          WORKER_NAME="${SLUG}-${APP_NAME}-preview-${PR_NUMBER}"

          echo "Worker name: ${WORKER_NAME}"
          echo "name=${WORKER_NAME}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Log database configuration
        if: inputs.enable_ephemeral_db == true
        run: |
          echo "::group::Database Configuration"

          if [ "${{ needs.manage-database.outputs.database_created }}" = "true" ]; then
            echo "‚úì Using ephemeral database"
            echo "  Database Name: ${{ needs.manage-database.outputs.database_name }}"
            echo "  Database ID: ${{ needs.manage-database.outputs.database_id }}"
            echo "  New Migrations: ${{ needs.manage-database.outputs.new_migration_count }}"
            echo ""
            echo "The artifact includes updated wrangler config with ephemeral database settings"
          else
            echo "‚ÑπÔ∏è  Using dev database (no new migrations detected)"
          fi

          echo "::endgroup::"

      - name: Deploy to Cloudflare Workers
        id: deploy-worker
        uses: algtools/actions/.github/actions/deploy-cloudflare-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          worker_name: ${{ steps.worker-name.outputs.name }}
          wrangler_config: ${{ inputs.wrangler_config }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          wrangler_version: ${{ inputs.wrangler_version }}
          deploy_environment: "preview"
          custom_domain: ${{ steps.preview-domain.outputs.domain }}
          zone_id: ${{ inputs.zone }}
          dry_run: "false"

      - name: Construct preview URL
        id: preview-url
        run: |
          echo "::group::Constructing preview URL"

          APP_DOMAIN="${{ inputs.app_domain }}"
          DEV_ZONE="${{ inputs.dev_zone }}"

          # Construct URL: https://{app_domain}.{dev_zone}
          # Note: app_domain already contains <alias>-<pr-number>.<slug>
          PREVIEW_URL="https://${APP_DOMAIN}.${DEV_ZONE}"

          echo "Preview URL: ${PREVIEW_URL}"
          echo "url=${PREVIEW_URL}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

  chromatic:
    name: Upload to Chromatic
    needs: build
    if: inputs.enable_chromatic == true
    runs-on: ubuntu-latest
    outputs:
      chromatic_url: ${{ steps.chromatic-upload.outputs.chromatic_url }}

    steps:
      - name: Validate Chromatic inputs
        run: |
          echo "::group::Validating Chromatic configuration"

          if [ -z "${{ secrets.chromatic_project_token }}" ]; then
            echo "::error::chromatic_project_token is required when enable_chromatic is true"
            exit 1
          fi

          if [ -z "${{ inputs.storybook_build_dir }}" ]; then
            echo "::error::storybook_build_dir is required when enable_chromatic is true"
            exit 1
          fi

          echo "‚úì Chromatic configuration validated"
          echo "::endgroup::"

      - name: Upload to Chromatic
        id: chromatic-upload
        uses: algtools/actions/.github/actions/chromatic-upload-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          project_token: ${{ secrets.chromatic_project_token }}
          storybook_dir: ${{ inputs.storybook_build_dir }}

  api-docs:
    name: Generate API Documentation
    needs: build
    if: inputs.enable_api_docs == true
    runs-on: ubuntu-latest
    outputs:
      api_docs_url: ${{ steps.generate-api-docs.outputs.api_docs_url }}
      api_docs_status: ${{ steps.generate-api-docs.outputs.status }}

    steps:
      - name: Validate API docs inputs
        run: |
          echo "::group::Validating API documentation configuration"

          echo "API Documentation Configuration:"
          echo "  Type: ${{ inputs.api_docs_type }}"
          echo "  Output Directory: ${{ inputs.api_docs_output_dir }}"
          echo ""

          # Validate API docs type
          case "${{ inputs.api_docs_type }}" in
            scalar|redoc|swagger-ui)
              echo "‚úì Valid API documentation type: ${{ inputs.api_docs_type }}"
              ;;
            *)
              echo "::error::Invalid api_docs_type: ${{ inputs.api_docs_type }}. Must be one of: scalar, redoc, swagger-ui"
              exit 1
              ;;
          esac

          echo "‚úì API documentation configuration validated"
          echo "::endgroup::"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ./artifact

      - name: Generate API Documentation
        id: generate-api-docs
        run: |
          echo "::group::Generating API Documentation"

          cd ./artifact
          API_DOCS_TYPE="${{ inputs.api_docs_type }}"
          OUTPUT_DIR="${{ inputs.api_docs_output_dir }}"

          # Create output directory
          mkdir -p "${OUTPUT_DIR}"

          # Generate documentation based on type
          case "${API_DOCS_TYPE}" in
            scalar)
              echo "Generating Scalar API documentation..."

              # Create Scalar HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API Documentation</title>
              <style>
                  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
                  .header { background: #6366f1; color: white; padding: 1rem; text-align: center; }
                  .content { padding: 2rem; }
                  .info { background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
                  .api-link { display: inline-block; background: #6366f1; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; margin: 0.5rem; }
                  .api-link:hover { background: #4f46e5; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>API Documentation</h1>
                  <p>Generated for PR Preview</p>
              </div>
              <div class="content">
                  <div class="info">
                      <h2>API Reference</h2>
                      <p>This is the API documentation for the preview deployment.</p>
                      <p><strong>Generated:</strong> $(date)</p>
                      <p><strong>Commit:</strong> ${{ github.sha }}</p>
                      <p><strong>PR:</strong> #${{ github.event.pull_request.number }}</p>
                  </div>

                  <h3>Available Endpoints</h3>
                  <a href="/docs" class="api-link">Interactive API Docs</a>
                  <a href="/openapi.json" class="api-link">OpenAPI Specification</a>
                  <a href="/health" class="api-link">Health Check</a>

                  <h3>API Base URL</h3>
                  <p>The API base URL will be dynamically determined based on the deployment environment.</p>

                  <h3>Preview Environment</h3>
                  <p>This is a preview deployment for PR #${{ github.event.pull_request.number }}.</p>
                  <p>The API endpoints are available at the preview URL with the same paths.</p>
              </div>
          </body>
          </html>
          EOF

              echo "‚úì Scalar documentation generated"
              ;;

            redoc)
              echo "Generating ReDoc API documentation..."

              # Create ReDoc HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>API Documentation</title>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">
              <style>
                  body { margin: 0; padding: 0; }
              </style>
          </head>
          <body>
              <redoc spec-url="/openapi.json"></redoc>
              <script src="https://cdn.jsdelivr.net/npm/redoc@2.0.0/bundles/redoc.standalone.js"></script>
          </body>
          </html>
          EOF

              echo "‚úì ReDoc documentation generated"
              ;;

            swagger-ui)
              echo "Generating Swagger UI API documentation..."

              # Create Swagger UI HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API Documentation</title>
              <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui.css" />
              <style>
                  html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
                  *, *:before, *:after { box-sizing: inherit; }
                  body { margin:0; background: #fafafa; }
              </style>
          </head>
          <body>
              <div id="swagger-ui"></div>
              <script src="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui-bundle.js"></script>
              <script src="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui-standalone-preset.js"></script>
              <script>
                  window.onload = function() {
                      const ui = SwaggerUIBundle({
                          url: '/openapi.json',
                          dom_id: '#swagger-ui',
                          presets: [
                              SwaggerUIBundle.presets.apis,
                              SwaggerUIStandalonePreset
                          ],
                          layout: "StandaloneLayout"
                      });
                  };
              </script>
          </body>
          </html>
          EOF

              echo "‚úì Swagger UI documentation generated"
              ;;
          esac

          # Upload API documentation as artifact
          cd ..
          cp -r ./artifact/"${OUTPUT_DIR}" ./api-docs

          echo "api_docs_url=https://${{ inputs.app_domain }}-pr-${{ github.event.pull_request.number }}.${{ inputs.dev_zone }}/docs" >> "$GITHUB_OUTPUT"
          echo "status=success" >> "$GITHUB_OUTPUT"

          echo "‚úì API documentation generation completed"
          echo "::endgroup::"

      - name: Upload API Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "api-docs-${{ inputs.artifact_name }}"
          path: api-docs
          retention-days: 7

  comment:
    name: Comment on PR
    needs: [deploy, chromatic, api-docs, manage-database]
    if: |
      always() &&
      needs.deploy.result == 'success' &&
      (inputs.enable_chromatic == false || needs.chromatic.result == 'success' || needs.chromatic.result == 'skipped') &&
      (inputs.enable_api_docs == false || needs.api-docs.result == 'success' || needs.api-docs.result == 'skipped') &&
      (inputs.enable_ephemeral_db == false || needs.manage-database.result == 'success' || needs.manage-database.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      comment_id: ${{ steps.comment-pr.outputs.comment_id }}
      comment_url: ${{ steps.comment-pr.outputs.comment_url }}

    steps:
      - name: Comment on PR
        id: comment-pr
        uses: algtools/actions/.github/actions/comment-pr@main
        with:
          pr_number: ${{ needs.deploy.outputs.pr_number }}
          dedupe_key: "pr-preview-deployment"
          message: |
            ## üöÄ Preview Environment Deployed

            Your preview environment is ready!

            ### üîó Links
            ${{ contains(inputs.preview_links, 'preview') && format('- üåê **Preview URL**: {0}', needs.deploy.outputs.preview_url) || '' }}
            ${{ contains(inputs.preview_links, 'storybook') && format('- üìö **Storybook**: {0}/storybook', needs.deploy.outputs.preview_url) || '' }}
            ${{ contains(inputs.preview_links, 'api-docs') && format('- üìö **API Docs**: {0}/docsz', needs.deploy.outputs.preview_url) || '' }}
            ${{ contains(inputs.preview_links, 'openapi-spec') && format('- üìã **OpenAPI Spec**: {0}/openapi.json', needs.deploy.outputs.preview_url) || '' }}
            ${{ contains(inputs.preview_links, 'health') && format('- üíö **Health Check**: {0}/healthz', needs.deploy.outputs.preview_url) || '' }}

            ### ‚ÑπÔ∏è Details
            - **Worker**: `${{ needs.deploy.outputs.worker_name }}`
            - **Environment**: `preview-${{ needs.deploy.outputs.pr_number }}`
            - **Commit**: `${{ github.event.pull_request.head.sha }}`
            - **Deployed**: <t:${{ github.event.pull_request.updated_at }}:R>
            ${{ inputs.enable_ephemeral_db && needs.manage-database.outputs.database_created == 'true' && format('- **Database**: Ephemeral DB `{0}` (testing {1} new migration{2})', needs.manage-database.outputs.database_name, needs.manage-database.outputs.new_migration_count, needs.manage-database.outputs.new_migration_count > 1 && 's' || '') || inputs.enable_ephemeral_db && '- **Database**: Dev database (no new migrations)' || '' }}

            <details>
            <summary>‚ñ∂ Deployment Info</summary>

            This environment will be automatically cleaned up when the PR is closed or merged.
            ${{ inputs.enable_ephemeral_db && needs.manage-database.outputs.database_created == 'true' && format('\n\n**Ephemeral Database**: A temporary database `{0}` was created to test new migrations. It will be automatically deleted when this PR is closed.', needs.manage-database.outputs.database_name) || '' }}

            </details>

      - name: Deployment Summary
        run: |
          {
            echo "## üöÄ PR Preview Deployment"
            echo ""
            echo "### Preview Environment"
            echo "- **URL**: ${{ needs.deploy.outputs.preview_url }}"
            echo "- **API Docs**: ${{ needs.deploy.outputs.preview_url }}/docs"
            echo "- **Worker**: \`${{ needs.deploy.outputs.worker_name }}\`"
            echo "- **Status**: ${{ needs.deploy.outputs.deployment_status }}"
            echo ""
            echo "‚úÖ Preview environment deployed successfully"
          } >> "$GITHUB_STEP_SUMMARY"
