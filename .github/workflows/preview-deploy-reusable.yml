name: 'Preview Deploy - Reusable Workflow'
# Reusable workflow for deploying PR previews to Cloudflare Workers
# Automatically posts/updates a comment on the PR with deployment info

on:
  workflow_call:
    inputs:
      # Build configuration
      build_cmd:
        description: 'Build command to execute (e.g., "npm run build", "tsc", "yarn build")'
        required: true
        type: string
      artifact_name:
        description: 'Name of the artifact to upload'
        required: true
        type: string
      artifact_paths:
        description: 'Comma-separated list of file paths or directories to upload as artifacts'
        required: true
        type: string
      node_version:
        description: 'Node.js version to install. If not provided, reads from .nvmrc file.'
        required: false
        type: string
        default: ''
      working_directory:
        description: 'Working directory for build commands'
        required: false
        type: string
        default: '.'
      output_dir:
        description: 'Directory where build output/artifacts will be produced (e.g., "dist", "build")'
        required: false
        type: string
        default: 'dist'

      # Deployment configuration
      worker_name:
        description: 'Name of the Cloudflare Worker for preview deployment'
        required: true
        type: string
      wrangler_config:
        description: 'Path to wrangler.toml configuration file relative to artifact root'
        required: false
        type: string
        default: 'wrangler.toml'
      zone:
        description: 'Cloudflare zone ID for the domain'
        required: true
        type: string
      custom_domain:
        description: 'Domain for wildcard certificate e.g., dev.example.com for *.dev.example.com'
        required: true
        type: string
      wrangler_version:
        description: 'Version of Wrangler to use for deployment (default: latest)'
        required: false
        type: string
        default: 'latest'

      # Preview URL configuration
      app_domain:
        description: 'Application domain prefix (used to construct preview URL: {app_domain}-pr-{num}.{dev_zone})'
        required: true
        type: string
      dev_zone:
        description: 'Development zone suffix for preview URLs (e.g., "dev.example.com")'
        required: true
        type: string

      # Chromatic configuration (optional)
      enable_chromatic:
        description: 'Enable Chromatic visual testing upload'
        required: false
        type: boolean
        default: false
      chromatic_project_token:
        description: 'Chromatic project token (required if enable_chromatic is true)'
        required: false
        type: string
        default: ''
      storybook_build_dir:
        description: 'Directory containing Storybook build (required if enable_chromatic is true)'
        required: false
        type: string
        default: 'storybook-static'

      # API Documentation configuration (optional)
      enable_api_docs:
        description: 'Enable API documentation generation'
        required: false
        type: boolean
        default: false
      api_docs_type:
        description: 'Type of API documentation to generate (scalar, redoc, swagger-ui)'
        required: false
        type: string
        default: 'scalar'
      api_docs_output_dir:
        description: 'Directory where API documentation will be generated'
        required: false
        type: string
        default: 'api-docs'

      # Miscellaneous
      retention_days:
        description: 'Number of days to retain the artifact (1-90 days, default is repository/org setting)'
        required: false
        type: number
        default: 30
      max_wait_seconds:
        description: 'Maximum time to wait for certificate activation in seconds (default: 300)'
        required: false
        type: number
        default: 300
      poll_interval_seconds:
        description: 'Interval between certificate status checks in seconds (default: 10)'
        required: false
        type: number
        default: 10

    secrets:
      cloudflare_api_token:
        description: 'Cloudflare API token with Workers deployment and SSL certificate permissions'
        required: true
      cloudflare_account_id:
        description: 'Cloudflare account ID'
        required: true

    outputs:
      # Build outputs
      artifact_id:
        description: 'GitHub artifact ID of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact_id }}
      artifact_url:
        description: 'URL to download the artifact'
        value: ${{ jobs.build.outputs.artifact_url }}
      build_status:
        description: 'Status of the build (success or failure)'
        value: ${{ jobs.build.outputs.build_status }}

      # Deploy outputs
      worker_url:
        description: 'URL of the deployed Cloudflare Worker'
        value: ${{ jobs.deploy.outputs.worker_url }}
      deployment_status:
        description: 'Status of the deployment'
        value: ${{ jobs.deploy.outputs.deployment_status }}
      certificate_id:
        description: 'ID of the wildcard SSL certificate'
        value: ${{ jobs.deploy.outputs.certificate_id }}

      # Preview outputs
      preview_url:
        description: 'Public preview URL for the PR'
        value: ${{ jobs.deploy.outputs.preview_url }}

      # Chromatic outputs
      chromatic_url:
        description: 'URL to Chromatic visual testing results (if enabled)'
        value: ${{ jobs.chromatic.outputs.chromatic_url }}

      # API Documentation outputs
      api_docs_url:
        description: 'URL to API documentation (if enabled)'
        value: ${{ jobs.api-docs.outputs.api_docs_url }}
      api_docs_status:
        description: 'Status of API documentation generation'
        value: ${{ jobs.api-docs.outputs.api_docs_status }}

      # Comment outputs
      comment_id:
        description: 'ID of the PR comment'
        value: ${{ jobs.comment.outputs.comment_id }}
      comment_url:
        description: 'URL of the PR comment'
        value: ${{ jobs.comment.outputs.comment_url }}

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact_id }}
      artifact_url: ${{ steps.upload.outputs.artifact_url }}
      total_files: ${{ steps.upload.outputs.total_files }}
      total_size: ${{ steps.upload.outputs.total_size }}
      build_status: ${{ steps.build.outputs.build_status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js securely
        id: setup
        uses: algtools/actions/.github/actions/setup-node@main
        with:
          node-version: ${{ inputs.node_version }}
          working-directory: ${{ inputs.working_directory }}
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      - name: Build without secrets
        id: build
        uses: algtools/actions/.github/actions/build-no-secrets@main
        with:
          build_cmd: ${{ inputs.build_cmd }}
          working_dir: ${{ inputs.working_directory }}
          output_dir: ${{ inputs.output_dir }}

      - name: Upload artifacts
        id: upload
        uses: algtools/actions/.github/actions/upload-artifacts@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          artifact_paths: ${{ inputs.artifact_paths }}
          retention_days: ${{ inputs.retention_days }}

  deploy:
    name: Deploy Preview
    needs: build
    runs-on: ubuntu-latest
    environment: 'preview-${{ github.event.pull_request.number }}'
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.worker_url }}
      deployment_status: ${{ steps.deploy-worker.outputs.deployment_status }}
      certificate_id: ${{ steps.ensure-cert.outputs.certificate_id }}
      preview_url: ${{ steps.preview-url.outputs.url }}
      pr_number: ${{ steps.resolve-pr.outputs.number }}

    steps:
      - name: Resolve PR number
        id: resolve-pr
        run: |
          echo "::group::Resolving PR number"

          PR_NUMBER=""

          # Try to get PR number from different event contexts
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Direct pull_request trigger
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "PR number from pull_request event: ${PR_NUMBER}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # workflow_run trigger (e.g., from pull_request_target or fork PRs)
            # Extract from head_branch if it follows a PR pattern
            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "Head branch from workflow_run: ${HEAD_BRANCH}"

            # Try to extract PR number from associated pull requests
            if [ -n "${{ github.event.workflow_run.pull_requests[0].number }}" ]; then
              PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
              echo "PR number from workflow_run pull_requests: ${PR_NUMBER}"
            fi
          fi

          # Fallback: try to extract from ref if it's a PR ref
          if [ -z "$PR_NUMBER" ]; then
            REF="${{ github.ref }}"
            if [[ "$REF" =~ refs/pull/([0-9]+)/ ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "PR number extracted from ref: ${PR_NUMBER}"
            fi
          fi

          # Validate PR number
          if [ -z "$PR_NUMBER" ]; then
            echo "::error::Could not resolve PR number from event context"
            echo "Event name: ${{ github.event_name }}"
            echo "Ref: ${{ github.ref }}"
            exit 1
          fi

          echo "‚úì Resolved PR number: ${PR_NUMBER}"
          echo "number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Ensure wildcard SSL certificate
        id: ensure-cert
        uses: algtools/actions/.github/actions/ensure-wildcard-certificate@main
        with:
          domain: ${{ inputs.custom_domain }}
          current_zone: ${{ inputs.zone }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          max_wait_seconds: ${{ inputs.max_wait_seconds }}
          poll_interval_seconds: ${{ inputs.poll_interval_seconds }}

      - name: Deploy to Cloudflare Workers
        id: deploy-worker
        uses: algtools/actions/.github/actions/deploy-cloudflare-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          worker_name: ${{ inputs.worker_name }}
          wrangler_config: ${{ inputs.wrangler_config }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          wrangler_version: ${{ inputs.wrangler_version }}
          deploy_environment: 'preview'
          dry_run: 'false'

      - name: Construct preview URL
        id: preview-url
        run: |
          echo "::group::Constructing preview URL"

          PR_NUM="${{ steps.resolve-pr.outputs.number }}"
          APP_DOMAIN="${{ inputs.app_domain }}"
          DEV_ZONE="${{ inputs.dev_zone }}"

          # Construct URL: {app_domain}-pr-{num}.{dev_zone}
          PREVIEW_URL="https://${APP_DOMAIN}-pr-${PR_NUM}.${DEV_ZONE}"

          echo "Preview URL: ${PREVIEW_URL}"
          echo "url=${PREVIEW_URL}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

  chromatic:
    name: Upload to Chromatic
    needs: build
    if: inputs.enable_chromatic == true
    runs-on: ubuntu-latest
    outputs:
      chromatic_url: ${{ steps.chromatic-upload.outputs.chromatic_url }}

    steps:
      - name: Validate Chromatic inputs
        run: |
          echo "::group::Validating Chromatic configuration"

          if [ -z "${{ inputs.chromatic_project_token }}" ]; then
            echo "::error::chromatic_project_token is required when enable_chromatic is true"
            exit 1
          fi

          if [ -z "${{ inputs.storybook_build_dir }}" ]; then
            echo "::error::storybook_build_dir is required when enable_chromatic is true"
            exit 1
          fi

          echo "‚úì Chromatic configuration validated"
          echo "::endgroup::"

      - name: Upload to Chromatic
        id: chromatic-upload
        uses: algtools/actions/.github/actions/chromatic-upload-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          project_token: ${{ inputs.chromatic_project_token }}
          storybook_dir: ${{ inputs.storybook_build_dir }}

  api-docs:
    name: Generate API Documentation
    needs: build
    if: inputs.enable_api_docs == true
    runs-on: ubuntu-latest
    outputs:
      api_docs_url: ${{ steps.generate-api-docs.outputs.api_docs_url }}
      api_docs_status: ${{ steps.generate-api-docs.outputs.status }}

    steps:
      - name: Validate API docs inputs
        run: |
          echo "::group::Validating API documentation configuration"

          echo "API Documentation Configuration:"
          echo "  Type: ${{ inputs.api_docs_type }}"
          echo "  Output Directory: ${{ inputs.api_docs_output_dir }}"
          echo ""

          # Validate API docs type
          case "${{ inputs.api_docs_type }}" in
            scalar|redoc|swagger-ui)
              echo "‚úì Valid API documentation type: ${{ inputs.api_docs_type }}"
              ;;
            *)
              echo "::error::Invalid api_docs_type: ${{ inputs.api_docs_type }}. Must be one of: scalar, redoc, swagger-ui"
              exit 1
              ;;
          esac

          echo "‚úì API documentation configuration validated"
          echo "::endgroup::"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ./artifact

      - name: Generate API Documentation
        id: generate-api-docs
        run: |
          echo "::group::Generating API Documentation"

          cd ./artifact
          API_DOCS_TYPE="${{ inputs.api_docs_type }}"
          OUTPUT_DIR="${{ inputs.api_docs_output_dir }}"

          # Create output directory
          mkdir -p "${OUTPUT_DIR}"

          # Generate documentation based on type
          case "${API_DOCS_TYPE}" in
            scalar)
              echo "Generating Scalar API documentation..."

              # Create Scalar HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API Documentation</title>
              <style>
                  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
                  .header { background: #6366f1; color: white; padding: 1rem; text-align: center; }
                  .content { padding: 2rem; }
                  .info { background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
                  .api-link { display: inline-block; background: #6366f1; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; margin: 0.5rem; }
                  .api-link:hover { background: #4f46e5; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>API Documentation</h1>
                  <p>Generated for PR Preview</p>
              </div>
              <div class="content">
                  <div class="info">
                      <h2>API Reference</h2>
                      <p>This is the API documentation for the preview deployment.</p>
                      <p><strong>Generated:</strong> $(date)</p>
                      <p><strong>Commit:</strong> ${{ github.sha }}</p>
                      <p><strong>PR:</strong> #${{ github.event.pull_request.number }}</p>
                  </div>

                  <h3>Available Endpoints</h3>
                  <a href="/docs" class="api-link">Interactive API Docs</a>
                  <a href="/openapi.json" class="api-link">OpenAPI Specification</a>
                  <a href="/health" class="api-link">Health Check</a>

                  <h3>API Base URL</h3>
                  <p>The API base URL will be dynamically determined based on the deployment environment.</p>

                  <h3>Preview Environment</h3>
                  <p>This is a preview deployment for PR #${{ github.event.pull_request.number }}.</p>
                  <p>The API endpoints are available at the preview URL with the same paths.</p>
              </div>
          </body>
          </html>
          EOF

              echo "‚úì Scalar documentation generated"
              ;;

            redoc)
              echo "Generating ReDoc API documentation..."

              # Create ReDoc HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>API Documentation</title>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">
              <style>
                  body { margin: 0; padding: 0; }
              </style>
          </head>
          <body>
              <redoc spec-url="/openapi.json"></redoc>
              <script src="https://cdn.jsdelivr.net/npm/redoc@2.0.0/bundles/redoc.standalone.js"></script>
          </body>
          </html>
          EOF

              echo "‚úì ReDoc documentation generated"
              ;;

            swagger-ui)
              echo "Generating Swagger UI API documentation..."

              # Create Swagger UI HTML documentation
              cat > "${OUTPUT_DIR}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>API Documentation</title>
              <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui.css" />
              <style>
                  html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
                  *, *:before, *:after { box-sizing: inherit; }
                  body { margin:0; background: #fafafa; }
              </style>
          </head>
          <body>
              <div id="swagger-ui"></div>
              <script src="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui-bundle.js"></script>
              <script src="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui-standalone-preset.js"></script>
              <script>
                  window.onload = function() {
                      const ui = SwaggerUIBundle({
                          url: '/openapi.json',
                          dom_id: '#swagger-ui',
                          presets: [
                              SwaggerUIBundle.presets.apis,
                              SwaggerUIStandalonePreset
                          ],
                          layout: "StandaloneLayout"
                      });
                  };
              </script>
          </body>
          </html>
          EOF

              echo "‚úì Swagger UI documentation generated"
              ;;
          esac

          # Upload API documentation as artifact
          cd ..
          cp -r ./artifact/"${OUTPUT_DIR}" ./api-docs

          echo "api_docs_url=https://${{ inputs.app_domain }}-pr-${{ github.event.pull_request.number }}.${{ inputs.dev_zone }}/docs" >> "$GITHUB_OUTPUT"
          echo "status=success" >> "$GITHUB_OUTPUT"

          echo "‚úì API documentation generation completed"
          echo "::endgroup::"

      - name: Upload API Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 'api-docs-${{ inputs.artifact_name }}'
          path: api-docs
          retention-days: 7

  comment:
    name: Comment on PR
    needs: [deploy, chromatic, api-docs]
    if: |
      always() &&
      needs.deploy.result == 'success' &&
      (inputs.enable_chromatic == false || needs.chromatic.result == 'success' || needs.chromatic.result == 'skipped') &&
      (inputs.enable_api_docs == false || needs.api-docs.result == 'success' || needs.api-docs.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      comment_id: ${{ steps.comment-pr.outputs.comment_id }}
      comment_url: ${{ steps.comment-pr.outputs.comment_url }}

    steps:
      - name: Post or update PR comment
        id: comment-pr
        uses: algtools/actions/.github/actions/comment-pr@main
        with:
          pr_number: ${{ needs.deploy.outputs.pr_number }}
          message: |
            ‚úÖ **Preview deployed successfully!**
            üåê [Open Preview](${{ needs.deploy.outputs.preview_url }})${{ inputs.enable_chromatic == true && needs.chromatic.outputs.chromatic_url != '' && format('
            üß© [Chromatic Visuals]({0})', needs.chromatic.outputs.chromatic_url) || '' }}${{ inputs.enable_api_docs == true && needs.api-docs.outputs.api_docs_url != '' && format('
            üìö [API Documentation]({0})', needs.api-docs.outputs.api_docs_url) || '' }}

            ---

            **Deployment Details:**
            - Worker: `${{ inputs.worker_name }}`
            - Environment: `preview`
            - Commit: `${{ github.sha }}`
          dedupe_key: 'preview-deploy'
      - name: Comment on PR
        uses: algtools/actions/.github/actions/comment-pr@main
        with:
          pr_number: ${{ needs.deploy.outputs.pr_number }}
          dedupe_key: 'pr-preview-deployment'
          message: |
            ## üöÄ Preview Environment Deployed

            Your preview environment is ready!

            ### üîó Links
            - üåê **Preview URL**: ${{ needs.deploy.outputs.preview_url }}
            - üìö **API Docs**: ${{ needs.deploy.outputs.preview_url }}/docs
            - üìã **OpenAPI Spec**: ${{ needs.deploy.outputs.preview_url }}/openapi.json
            - üíö **Health Check**: ${{ needs.deploy.outputs.preview_url }}/health

            ### ‚ÑπÔ∏è Details
            - **Worker**: `${{ inputs.worker_name }}`
            - **Environment**: `preview-${{ needs.deploy.outputs.pr_number }}`
            - **Commit**: `${{ github.event.pull_request.head.sha }}`
            - **Deployed**: <t:${{ github.event.pull_request.updated_at }}:R>

            <details>
            <summary>Deployment Info</summary>

            - **Artifact**: `pr-preview-${{ github.event.pull_request.number }}`
            - **Build Status**: ‚úÖ Success
            - **Deployment Status**: ${{ needs.deploy.outputs.deployment_status }}

            </details>

            > This environment will be automatically cleaned up when the PR is closed or merged.

      - name: Deployment Summary
        run: |
          {
            echo "## üöÄ PR Preview Deployment"
            echo ""
            echo "### Preview Environment"
            echo "- **URL**: ${{ needs.deploy.outputs.preview_url }}"
            echo "- **API Docs**: ${{ needs.deploy.outputs.preview_url }}/docs"
            echo "- **Worker**: \`${{ inputs.worker_name }}\`"
            echo "- **Status**: ${{ needs.deploy.outputs.deployment_status }}"
            echo ""
            echo "‚úÖ Preview environment deployed successfully"
          } >> "$GITHUB_STEP_SUMMARY"
