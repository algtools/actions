name: "Environment Deploy - Reusable Workflow"

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment for deployment (e.g., "dev", "qa", "production")'
        required: true
        type: string
      wrangler_config:
        description: "Path to wrangler.toml configuration file (relative to artifact root)"
        required: true
        type: string
      zone:
        description: "Cloudflare zone ID for the domain"
        required: true
        type: string
      worker_name:
        description: "Name of the Cloudflare Worker to deploy"
        required: true
        type: string
      artifact_name:
        description: "Name of the artifact containing the built worker code"
        required: true
        type: string
      custom_domain:
        description: "Domain for wildcard certificate (e.g., example.com for *.example.com)"
        required: true
        type: string
      wrangler_version:
        description: 'Version of Wrangler to use (e.g., "3.78.0" or "latest")'
        required: false
        type: string
        default: "latest"
      download_path:
        description: "Directory path where the artifact will be downloaded"
        required: false
        type: string
        default: "./worker-artifact"
      max_wait_seconds:
        description: "Maximum time to wait for certificate activation (in seconds)"
        required: false
        type: number
        default: 300
      poll_interval_seconds:
        description: "Interval between certificate status checks (in seconds)"
        required: false
        type: number
        default: 10
      sentry_release:
        description: "Enable Sentry release tracking (true/false). Requires sentry_auth_token, sentry_org, and sentry_project."
        required: false
        type: boolean
        default: false
      sentry_org:
        description: "Sentry organization slug (required if sentry_release is true)"
        required: false
        type: string
        default: ""
      sentry_project:
        description: "Sentry project slug (required if sentry_release is true)"
        required: false
        type: string
        default: ""
      create_github_release:
        description: "Create a GitHub release (typically true for production)"
        required: false
        type: boolean
        default: false
      package_json_path:
        description: "Path to package.json for version extraction (relative to artifact root)"
        required: false
        type: string
        default: "package.json"
      release_name_template:
        description: "Template for release name (use {version} placeholder)"
        required: false
        type: string
        default: "Release {version}"
    secrets:
      cloudflare_api_token:
        description: "Cloudflare API token with Workers deployment and SSL certificate permissions"
        required: true
      cloudflare_account_id:
        description: "Cloudflare account ID"
        required: true
      sentry_auth_token:
        description: "Sentry authentication token (required if sentry_release is true)"
        required: false
    outputs:
      worker_url:
        description: "URL of the deployed Cloudflare Worker"
        value: ${{ jobs.deploy.outputs.worker_url }}
      deployment_status:
        description: "Status of the deployment (success or failure)"
        value: ${{ jobs.deploy.outputs.deployment_status }}
      worker_version:
        description: "Version identifier of the deployed worker"
        value: ${{ jobs.deploy.outputs.worker_version }}
      certificate_id:
        description: "ID of the wildcard SSL certificate"
        value: ${{ jobs.deploy.outputs.certificate_id }}
      certificate_status:
        description: "Status of the SSL certificate"
        value: ${{ jobs.deploy.outputs.certificate_status }}
      certificate_created:
        description: "Whether a new certificate was created (true/false)"
        value: ${{ jobs.deploy.outputs.certificate_created }}
      release_created:
        description: "Whether a GitHub release was created"
        value: ${{ jobs.release.outputs.created }}
      release_tag:
        description: "Tag name of the created release"
        value: ${{ jobs.release.outputs.tag }}
      release_version:
        description: "Version of the created release"
        value: ${{ jobs.release.outputs.version }}

permissions:
  contents: write
  pull-requests: write
  deployments: write

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.worker_url }}
      deployment_status: ${{ steps.deploy-worker.outputs.deployment_status }}
      worker_version: ${{ steps.deploy-worker.outputs.worker_version }}
      certificate_id: ${{ steps.ensure-cert.outputs.certificate_id }}
      certificate_status: ${{ steps.ensure-cert.outputs.certificate_status }}
      certificate_created: ${{ steps.ensure-cert.outputs.certificate_created }}

    steps:
      - name: Validate inputs
        run: |
          echo "::group::Validating workflow inputs"

          # Validate required inputs
          if [ -z "${{ inputs.environment }}" ]; then
            echo "::error::environment input is required"
            exit 1
          fi
          if [ -z "${{ inputs.wrangler_config }}" ]; then
            echo "::error::wrangler_config input is required"
            exit 1
          fi
          if [ -z "${{ inputs.zone }}" ]; then
            echo "::error::zone input is required"
            exit 1
          fi
          if [ -z "${{ inputs.worker_name }}" ]; then
            echo "::error::worker_name input is required"
            exit 1
          fi
          if [ -z "${{ inputs.artifact_name }}" ]; then
            echo "::error::artifact_name input is required"
            exit 1
          fi
          if [ -z "${{ inputs.custom_domain }}" ]; then
            echo "::error::custom_domain input is required"
            exit 1
          fi

          # Validate Sentry inputs if enabled
          if [ "${{ inputs.sentry_release }}" = "true" ]; then
            if [ -z "${{ inputs.sentry_org }}" ]; then
              echo "::error::sentry_org is required when sentry_release is enabled"
              exit 1
            fi
            if [ -z "${{ inputs.sentry_project }}" ]; then
              echo "::error::sentry_project is required when sentry_release is enabled"
              exit 1
            fi
            if [ -z "${{ secrets.sentry_auth_token }}" ]; then
              echo "::error::sentry_auth_token secret is required when sentry_release is enabled"
              exit 1
            fi
          fi

          echo "‚úì All required inputs validated successfully"
          echo ""
          echo "Deployment Configuration:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Worker: ${{ inputs.worker_name }}"
          echo "  Zone ID: $(echo "${{ inputs.zone }}" | head -c 8)***"
          echo "  Domain: ${{ inputs.custom_domain }}"
          echo "  Artifact: ${{ inputs.artifact_name }}"
          echo "  Wrangler Config: ${{ inputs.wrangler_config }}"
          echo "  Wrangler Version: ${{ inputs.wrangler_version }}"
          echo "  Sentry Release: ${{ inputs.sentry_release }}"
          echo "::endgroup::"

      - name: Ensure wildcard certificate
        id: ensure-cert
        uses: algtools/actions/.github/actions/ensure-wildcard-certificate@main
        with:
          domain: ${{ inputs.custom_domain }}
          current_zone: ${{ inputs.zone }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          max_wait_seconds: ${{ inputs.max_wait_seconds }}
          poll_interval_seconds: ${{ inputs.poll_interval_seconds }}

      - name: Deploy Cloudflare Worker from artifact
        id: deploy-worker
        uses: algtools/actions/.github/actions/deploy-cloudflare-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          worker_name: ${{ inputs.worker_name }}
          wrangler_config: ${{ inputs.wrangler_config }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          download_path: ${{ inputs.download_path }}
          wrangler_version: ${{ inputs.wrangler_version }}
          deploy_environment: ${{ inputs.environment }}
          dry_run: "false"

      - name: Create Sentry release
        if: inputs.sentry_release == true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.sentry_auth_token }}
          SENTRY_ORG: ${{ inputs.sentry_org }}
          SENTRY_PROJECT: ${{ inputs.sentry_project }}
        run: |
          echo "::group::Creating Sentry release"

          # Install Sentry CLI
          echo "Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash

          # Create release version (using git SHA or timestamp)
          RELEASE_VERSION="${{ github.sha }}"
          echo "Release version: $RELEASE_VERSION"

          # Create Sentry release
          echo "Creating Sentry release..."
          sentry-cli releases new "$RELEASE_VERSION" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          # Associate commits with the release (if in a git repo)
          if [ -d ".git" ]; then
            echo "Associating commits with release..."
            sentry-cli releases set-commits "$RELEASE_VERSION" --auto \
              --org "$SENTRY_ORG" \
              --project "$SENTRY_PROJECT" || echo "‚ö†Ô∏è  Could not associate commits"
          fi

          # Finalize the release
          echo "Finalizing Sentry release..."
          sentry-cli releases finalize "$RELEASE_VERSION" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          # Create deployment
          echo "Creating Sentry deployment..."
          sentry-cli releases deploys "$RELEASE_VERSION" new \
            --env "${{ inputs.environment }}" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          echo "‚úì Sentry release created successfully"
          echo "  Version: $RELEASE_VERSION"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Organization: $SENTRY_ORG"
          echo "  Project: $SENTRY_PROJECT"
          echo "::endgroup::"

      # PR Comment Integration (ALG-15)
      # Automatically posts deployment status to associated PRs
      # Skips gracefully if no PR is associated (e.g., direct branch pushes)
      - name: Get PR number
        id: pr
        run: |
          # Check if this workflow run is associated with a pull request
          PR_NUMBER=""

          # Try to get PR number from various GitHub context sources
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_target" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ -n "${{ github.event.issue.number }}" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          if [ -n "$PR_NUMBER" ]; then
            echo "‚úì Detected PR #$PR_NUMBER"
          else
            echo "‚Ñπ No PR associated with this workflow run"
          fi

      # Post deployment summary comment to PR (only if PR exists)
      # Uses dedupe_key to update existing comments instead of creating duplicates
      - name: Comment on PR
        if: steps.pr.outputs.pr_number != ''
        uses: algtools/actions/.github/actions/comment-pr@main
        with:
          pr_number: ${{ steps.pr.outputs.pr_number }}
          dedupe_key: "env-deploy-${{ inputs.environment }}"
          message: |
            ‚úÖ **Deployment completed successfully**

            **Environment:** `${{ inputs.environment }}`
            üåê [Visit App](${{ steps.deploy-worker.outputs.worker_url }})
            üïí `${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}`
            üßæ **Release:** `${{ inputs.sentry_release == true && github.sha || steps.deploy-worker.outputs.worker_version }}`

            <details>
            <summary>Deployment Details</summary>

            ### Worker Details
            - **Name**: `${{ inputs.worker_name }}`
            - **Version**: `${{ steps.deploy-worker.outputs.worker_version }}`
            - **Artifact**: `${{ inputs.artifact_name }}`

            ### SSL Certificate
            - **Domain**: `*.${{ inputs.custom_domain }}`
            - **Certificate ID**: `${{ steps.ensure-cert.outputs.certificate_id }}`
            - **Status**: ${{ steps.ensure-cert.outputs.certificate_status }}
            - **Created New**: ${{ steps.ensure-cert.outputs.certificate_created }}
            ${{ inputs.sentry_release == true && format('\n### Sentry Release\n- **Organization**: `{0}`\n- **Project**: `{1}`\n- **Version**: `{2}`', inputs.sentry_org, inputs.sentry_project, github.sha) || '' }}
            </details>

      - name: Deployment summary
        run: |
          {
            echo "## üöÄ Deployment Summary"
            echo ""
            echo "### Environment"
            echo "- **Target**: \`${{ inputs.environment }}\`"
            echo "- **Status**: ‚úÖ ${{ steps.deploy-worker.outputs.deployment_status }}"
            echo ""
            echo "### Worker Details"
            echo "- **Name**: \`${{ inputs.worker_name }}\`"
            echo "- **URL**: ${{ steps.deploy-worker.outputs.worker_url }}"
            echo "- **Version**: \`${{ steps.deploy-worker.outputs.worker_version }}\`"
            echo "- **Artifact**: \`${{ inputs.artifact_name }}\`"
            echo ""
            echo "### SSL Certificate"
            echo "- **Domain**: \`*.${{ inputs.custom_domain }}\`"
            echo "- **Certificate ID**: \`${{ steps.ensure-cert.outputs.certificate_id }}\`"
            echo "- **Status**: ${{ steps.ensure-cert.outputs.certificate_status }}"
            echo "- **Created New**: ${{ steps.ensure-cert.outputs.certificate_created }}"
            echo ""
            echo "### Infrastructure"
            echo "- **Zone ID**: \`$(echo "${{ inputs.zone }}" | head -c 8)***\`"
            echo ""

            if [ "${{ inputs.sentry_release }}" = "true" ]; then
              echo "### Sentry Release"
              echo "- **Enabled**: ‚úÖ Yes"
              echo "- **Organization**: \`${{ inputs.sentry_org }}\`"
              echo "- **Project**: \`${{ inputs.sentry_project }}\`"
              echo "- **Version**: \`${{ github.sha }}\`"
              echo ""
            fi

            echo "### Security"
            echo "- ‚úÖ Credentials protected and redacted from logs"
            echo "- ‚úÖ Wildcard SSL certificate active"
            echo "- ‚úÖ Deployment from verified artifact"
            echo ""
            echo "---"
            echo ""
            echo "**Deployment completed successfully at $(date -u '+%Y-%m-%d %H:%M:%S UTC')**"
          } >> "$GITHUB_STEP_SUMMARY"

  release:
    name: Create GitHub Release
    needs: deploy
    if: inputs.create_github_release == true && inputs.environment == 'production'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      created: ${{ steps.create_release.outcome == 'success' }}
      tag: ${{ steps.get_version.outputs.tag }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifact for version info
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ./release-artifact

      - name: Get version from package.json
        id: get_version
        run: |
          if [ -f "./release-artifact/${{ inputs.package_json_path }}" ]; then
            VERSION=$(node -p "require('./release-artifact/${{ inputs.package_json_path }}').version")
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
            echo "‚úì Version extracted: ${VERSION}"
          else
            echo "::warning::package.json not found at ./release-artifact/${{ inputs.package_json_path }}, using timestamp"
            VERSION=$(date -u '+%Y.%m.%d-%H%M%S')
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
            echo "‚úì Using timestamp version: ${VERSION}"
          fi

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "${{ steps.get_version.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Tag ${{ steps.get_version.outputs.tag }} already exists, skipping release creation"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "‚úì Tag ${{ steps.get_version.outputs.tag }} does not exist, will create release"
          fi

      - name: Generate release notes
        if: steps.check_tag.outputs.exists == 'false'
        id: release_notes
        run: |
          echo "::group::Generating release notes"

          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          else
            echo "Previous tag: $PREV_TAG"
            COMMITS=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create release notes
          cat << 'EOFNOTES' > release_notes.md
          ## üöÄ Production Deployment

          **Version**: ${{ steps.get_version.outputs.version }}
          **Deployed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Commit**: `${{ github.sha }}`
          **Environment**: `${{ inputs.environment }}`

          ### üîó Deployment Links
          - üåê **Application**: ${{ needs.deploy.outputs.worker_url }}
          - üìö **API Docs**: ${{ needs.deploy.outputs.worker_url }}/docs
          - üíö **Health Check**: ${{ needs.deploy.outputs.worker_url }}/health

          ### üìù Changes Since Last Release
          EOFNOTES

          if [ -n "$COMMITS" ]; then
            echo "$COMMITS" >> release_notes.md
          else
            echo "- Initial release" >> release_notes.md
          fi

          cat << 'EOFNOTES' >> release_notes.md

          ### üîß Deployment Details
          - **Worker Name**: `${{ inputs.worker_name }}`
          - **Domain**: `${{ inputs.custom_domain }}`
          - **Artifact**: `${{ inputs.artifact_name }}`
          - **Worker Version**: `${{ needs.deploy.outputs.worker_version }}`
          EOFNOTES

          if [ "${{ inputs.sentry_release }}" = "true" ]; then
            cat << 'EOFNOTES' >> release_notes.md

          ### üìä Monitoring
          - **Sentry Release**: `${{ github.sha }}`
          - **Sentry Org**: `${{ inputs.sentry_org }}`
          - **Sentry Project**: `${{ inputs.sentry_project }}`
          EOFNOTES
          fi

          echo "‚úì Release notes generated"
          echo "::endgroup::"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: ${{ format(inputs.release_name_template, steps.get_version.outputs.version) }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          {
            echo "## üì¶ GitHub Release Created"
            echo ""
            echo "### Release Details"
            echo "- **Tag**: \`${{ steps.get_version.outputs.tag }}\`"
            echo "- **Version**: \`${{ steps.get_version.outputs.version }}\`"
            echo "- **Name**: ${{ format(inputs.release_name_template, steps.get_version.outputs.version) }}"
            echo "- **Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}"
            echo ""
            echo "### Deployment Info"
            echo "- **Environment**: ${{ inputs.environment }}"
            echo "- **Worker**: ${{ inputs.worker_name }}"
            echo "- **URL**: ${{ needs.deploy.outputs.worker_url }}"
            echo ""
            echo "‚úÖ Release published successfully"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Skipped Summary
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          {
            echo "## ‚ö†Ô∏è Release Creation Skipped"
            echo ""
            echo "Tag \`${{ steps.get_version.outputs.tag }}\` already exists."
            echo ""
            echo "To create a new release:"
            echo "1. Update the version in package.json"
            echo "2. Commit and push to main"
            echo "3. Re-run the deployment"
          } >> "$GITHUB_STEP_SUMMARY"
