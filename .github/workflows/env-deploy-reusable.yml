name: "Environment Deploy - Reusable Workflow"

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment for deployment (e.g., "dev", "qa", "production")'
        required: true
        type: string
      wrangler_config:
        description: "Path to wrangler.toml configuration file (relative to artifact root)"
        required: true
        type: string
      zone:
        description: "Cloudflare zone ID for the domain"
        required: true
        type: string
      slug:
        description: 'Project slug (e.g., "template", "bff-template")'
        required: true
        type: string
      app_name:
        description: 'Application name (e.g., "api", "web")'
        required: true
        type: string
      artifact_name:
        description: "Name of the artifact containing the built worker code"
        required: true
        type: string
      custom_domain:
        description: "Custom domain for the deployment (e.g., api.example.com). SSL certificate must be pre-generated using the generate-ssl-certificate workflow."
        required: true
        type: string
      wrangler_version:
        description: 'Version of Wrangler to use (e.g., "3.78.0" or "latest")'
        required: false
        type: string
        default: "latest"
      download_path:
        description: "Directory path where the artifact will be downloaded"
        required: false
        type: string
        default: "./worker-artifact"
      sentry_release:
        description: "Enable Sentry release tracking (true/false). Requires sentry_auth_token, sentry_org, and sentry_project."
        required: false
        type: boolean
        default: false
      sentry_org:
        description: "Sentry organization slug (required if sentry_release is true)"
        required: false
        type: string
        default: ""
      sentry_project:
        description: "Sentry project slug (required if sentry_release is true)"
        required: false
        type: string
        default: ""
      create_github_release:
        description: "Create a GitHub release (typically true for production)"
        required: false
        type: boolean
        default: false
      package_json_path:
        description: "Path to package.json for version extraction (relative to artifact root)"
        required: false
        type: string
        default: "package.json"
      release_name_template:
        description: "Template for release name (use {0} as version placeholder)"
        required: false
        type: string
        default: "Release {0}"
    secrets:
      cloudflare_api_token:
        description: "Cloudflare API token with Workers deployment permissions"
        required: true
      cloudflare_account_id:
        description: "Cloudflare account ID"
        required: true
      sentry_auth_token:
        description: "Sentry authentication token (required if sentry_release is true)"
        required: false
    outputs:
      worker_url:
        description: "URL of the deployed Cloudflare Worker"
        value: ${{ jobs.deploy.outputs.worker_url }}
      deployment_status:
        description: "Status of the deployment (success or failure)"
        value: ${{ jobs.deploy.outputs.deployment_status }}
      worker_version:
        description: "Version identifier of the deployed worker"
        value: ${{ jobs.deploy.outputs.worker_version }}

permissions:
  contents: write
  pull-requests: write
  deployments: write

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.custom_domain }}
    outputs:
      worker_url: ${{ steps.deploy-worker.outputs.worker_url }}
      deployment_status: ${{ steps.deploy-worker.outputs.deployment_status }}
      worker_version: ${{ steps.deploy-worker.outputs.worker_version }}
      worker_name: ${{ steps.worker-name.outputs.name }}

    steps:
      - name: Validate inputs
        run: |
          echo "::group::Validating workflow inputs"

          # Validate required inputs
          if [ -z "${{ inputs.environment }}" ]; then
            echo "::error::environment input is required"
            exit 1
          fi
          if [ -z "${{ inputs.wrangler_config }}" ]; then
            echo "::error::wrangler_config input is required"
            exit 1
          fi
          if [ -z "${{ inputs.zone }}" ]; then
            echo "::error::zone input is required"
            exit 1
          fi
          if [ -z "${{ inputs.slug }}" ]; then
            echo "::error::slug input is required"
            exit 1
          fi
          if [ -z "${{ inputs.app_name }}" ]; then
            echo "::error::app_name input is required"
            exit 1
          fi
          if [ -z "${{ inputs.artifact_name }}" ]; then
            echo "::error::artifact_name input is required"
            exit 1
          fi
          if [ -z "${{ inputs.custom_domain }}" ]; then
            echo "::error::custom_domain input is required"
            exit 1
          fi

          # Validate Sentry inputs if enabled
          if [ "${{ inputs.sentry_release }}" = "true" ]; then
            if [ -z "${{ inputs.sentry_org }}" ]; then
              echo "::error::sentry_org is required when sentry_release is enabled"
              exit 1
            fi
            if [ -z "${{ inputs.sentry_project }}" ]; then
              echo "::error::sentry_project is required when sentry_release is enabled"
              exit 1
            fi
            if [ -z "${{ secrets.sentry_auth_token }}" ]; then
              echo "::error::sentry_auth_token secret is required when sentry_release is enabled"
              exit 1
            fi
          fi

          echo "âœ“ All required inputs validated successfully"
          echo ""
          echo "Deployment Configuration:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Zone ID: $(echo "${{ inputs.zone }}" | head -c 8)***"
          echo "  Domain: ${{ inputs.custom_domain }}"
          echo "  Artifact: ${{ inputs.artifact_name }}"
          echo "  Wrangler Config: ${{ inputs.wrangler_config }}"
          echo "  Wrangler Version: ${{ inputs.wrangler_version }}"
          echo "  Sentry Release: ${{ inputs.sentry_release }}"
          echo "::endgroup::"

      - name: Construct worker name
        id: worker-name
        run: |
          echo "::group::Constructing worker name"

          ENV="${{ inputs.environment }}"
          SLUG="${{ inputs.slug }}"
          APP_NAME="${{ inputs.app_name }}"

          # Construct worker name based on environment
          case "$ENV" in
            dev)
              WORKER_NAME="${SLUG}-${APP_NAME}-dev"
              ;;
            qa)
              WORKER_NAME="${SLUG}-${APP_NAME}-qa"
              ;;
            main|production)
              WORKER_NAME="${SLUG}-${APP_NAME}-prod"
              ;;
            *)
              WORKER_NAME="${SLUG}-${APP_NAME}-${ENV}"
              ;;
          esac

          echo "Environment: ${ENV}"
          echo "Worker name: ${WORKER_NAME}"
          echo "name=${WORKER_NAME}" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Deploy Cloudflare Worker from artifact
        id: deploy-worker
        uses: algtools/actions/.github/actions/deploy-cloudflare-from-artifact@main
        with:
          artifact_name: ${{ inputs.artifact_name }}
          worker_name: ${{ steps.worker-name.outputs.name }}
          wrangler_config: ${{ inputs.wrangler_config }}
          cloudflare_api_token: ${{ secrets.cloudflare_api_token }}
          cloudflare_account_id: ${{ secrets.cloudflare_account_id }}
          download_path: ${{ inputs.download_path }}
          wrangler_version: ${{ inputs.wrangler_version }}
          deploy_environment: ${{ inputs.environment }}
          custom_domain: ${{ inputs.custom_domain }}
          zone_id: ${{ inputs.zone }}
          dry_run: "false"

      - name: Create Sentry release
        if: inputs.sentry_release == true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.sentry_auth_token }}
          SENTRY_ORG: ${{ inputs.sentry_org }}
          SENTRY_PROJECT: ${{ inputs.sentry_project }}
        run: |
          echo "::group::Creating Sentry release"

          # Install Sentry CLI
          echo "Installing Sentry CLI..."
          curl -sL https://sentry.io/get-cli/ | bash

          # Create release version (using git SHA or timestamp)
          RELEASE_VERSION="${{ github.sha }}"
          echo "Release version: $RELEASE_VERSION"

          # Create Sentry release
          echo "Creating Sentry release..."
          sentry-cli releases new "$RELEASE_VERSION" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          # Associate commits with the release (if in a git repo)
          if [ -d ".git" ]; then
            echo "Associating commits with release..."
            sentry-cli releases set-commits "$RELEASE_VERSION" --auto \
              --org "$SENTRY_ORG" \
              --project "$SENTRY_PROJECT" || echo "âš ï¸  Could not associate commits"
          fi

          # Finalize the release
          echo "Finalizing Sentry release..."
          sentry-cli releases finalize "$RELEASE_VERSION" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          # Create deployment
          echo "Creating Sentry deployment..."
          sentry-cli releases deploys "$RELEASE_VERSION" new \
            --env "${{ inputs.environment }}" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT"

          echo "âœ“ Sentry release created successfully"
          echo "  Version: $RELEASE_VERSION"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Organization: $SENTRY_ORG"
          echo "  Project: $SENTRY_PROJECT"
          echo "::endgroup::"

      # PR Comment Integration (ALG-15)
      # Automatically posts deployment status to associated PRs
      # Skips gracefully if no PR is associated (e.g., direct branch pushes)
      - name: Get PR number
        id: pr
        run: |
          # Check if this workflow run is associated with a pull request
          PR_NUMBER=""

          # Try to get PR number from various GitHub context sources
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_target" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ -n "${{ github.event.issue.number }}" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          if [ -n "$PR_NUMBER" ]; then
            echo "âœ“ Detected PR #$PR_NUMBER"
          else
            echo "â„¹ No PR associated with this workflow run"
          fi

      # Post deployment summary comment to PR (only if PR exists)
      # Uses dedupe_key to update existing comments instead of creating duplicates
      - name: Comment on PR
        if: steps.pr.outputs.pr_number != ''
        uses: algtools/actions/.github/actions/comment-pr@main
        with:
          pr_number: ${{ steps.pr.outputs.pr_number }}
          dedupe_key: "env-deploy-${{ inputs.environment }}"
          message: |
            âœ… **Deployment completed successfully**

            **Environment:** `${{ inputs.environment }}`
            ğŸŒ [Visit App](${{ steps.deploy-worker.outputs.worker_url }})
            ğŸ•’ `${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}`
            ğŸ§¾ **Release:** `${{ inputs.sentry_release == true && github.sha || steps.deploy-worker.outputs.worker_version }}`

            <details>
            <summary>Deployment Details</summary>

            ### Worker Details
            - **Name**: `${{ steps.worker-name.outputs.name }}`
            - **Version**: `${{ steps.deploy-worker.outputs.worker_version }}`
            - **Artifact**: `${{ inputs.artifact_name }}`
            - **Domain**: `${{ inputs.custom_domain }}`
            ${{ inputs.sentry_release == true && format('\n### Sentry Release\n- **Organization**: `{0}`\n- **Project**: `{1}`\n- **Version**: `{2}`', inputs.sentry_org, inputs.sentry_project, github.sha) || '' }}
            </details>

      - name: Deployment summary
        run: |
          {
            echo "## ğŸš€ Deployment Summary"
            echo ""
            echo "### Environment"
            echo "- **Target**: \`${{ inputs.environment }}\`"
            echo "- **Status**: âœ… ${{ steps.deploy-worker.outputs.deployment_status }}"
            echo ""
            echo "### Worker Details"
            echo "- **Name**: \`${{ steps.worker-name.outputs.name }}\`"
            echo "- **URL**: ${{ steps.deploy-worker.outputs.worker_url }}"
            echo "- **Version**: \`${{ steps.deploy-worker.outputs.worker_version }}\`"
            echo "- **Artifact**: \`${{ inputs.artifact_name }}\`"
            echo "- **Domain**: \`${{ inputs.custom_domain }}\`"
            echo ""
            echo "### Infrastructure"
            echo "- **Zone ID**: \`$(echo "${{ inputs.zone }}" | head -c 8)***\`"
            echo ""

            if [ "${{ inputs.sentry_release }}" = "true" ]; then
              echo "### Sentry Release"
              echo "- **Enabled**: âœ… Yes"
              echo "- **Organization**: \`${{ inputs.sentry_org }}\`"
              echo "- **Project**: \`${{ inputs.sentry_project }}\`"
              echo "- **Version**: \`${{ github.sha }}\`"
              echo ""
            fi

            echo "### Security"
            echo "- âœ… Credentials protected and redacted from logs"
            echo "- âœ… SSL certificate pre-generated (use generate-ssl-certificate workflow)"
            echo "- âœ… Deployment from verified artifact"
            echo ""
            echo "---"
            echo ""
            echo "**Deployment completed successfully at $(date -u '+%Y-%m-%d %H:%M:%S UTC')**"
          } >> "$GITHUB_STEP_SUMMARY"
